# ==============================================================================
# Follower Command Schema - Unified Protocol Definition
# ==============================================================================
# This file defines all available command fields and follower profiles
# for the Pixeagle drone control system. This schema replaces hardcoded
# profile definitions and enables extensible follower modes.

# Schema version for future compatibility
schema_version: "1.0.0"

# ==============================================================================
# Command Field Definitions
# ==============================================================================
# All possible command fields that can be used by any follower mode
# NOTE: Velocity/altitude limits are now defined in config_default.yaml SafetyLimits section
# This schema only defines field types, units, and descriptions.
# Clamping behavior is still defined here (clamp: true/false).
command_fields:
  # === Velocity Control Fields ===
  vel_x:
    type: float
    default: 0.0
    unit: "m/s"
    description: "Body frame X velocity (forward/backward)"
    # Limits defined in config_default.yaml SafetyLimits.MAX_VELOCITY_FORWARD
    clamp: true

  vel_y:
    type: float
    default: 0.0
    unit: "m/s"
    description: "Body frame Y velocity (left/right)"
    # Limits defined in config_default.yaml SafetyLimits.MAX_VELOCITY_LATERAL
    clamp: true

  vel_z:
    type: float
    default: 0.0
    unit: "m/s"
    description: "Body frame Z velocity (up/down)"
    # Limits defined in config_default.yaml SafetyLimits.MAX_VELOCITY_VERTICAL
    clamp: true

  # DEPRECATED: Use yawspeed_deg_s instead (deg/s standard)
  # Kept temporarily for backward compatibility - will be removed
  yaw_rate:
    type: float
    default: 0.0
    unit: "rad/s"
    description: "[DEPRECATED] Use yawspeed_deg_s instead"
    deprecated: true
    replacement: "yawspeed_deg_s"
    clamp: true

  # === Body Velocity Fields for Quadcopter Offboard Control ===
  vel_body_fwd:
    type: float
    default: 0.0
    unit: "m/s"
    description: "Body frame forward velocity (positive = forward)"
    # Limits defined in config_default.yaml SafetyLimits.MAX_VELOCITY_FORWARD
    clamp: true

  vel_body_right:
    type: float
    default: 0.0
    unit: "m/s"
    description: "Body frame right velocity (positive = right)"
    # Limits defined in config_default.yaml SafetyLimits.MAX_VELOCITY_LATERAL
    clamp: true

  vel_body_down:
    type: float
    default: 0.0
    unit: "m/s"
    description: "Body frame down velocity (positive = down)"
    # Limits defined in config_default.yaml SafetyLimits.MAX_VELOCITY_VERTICAL
    clamp: true

  yawspeed_deg_s:
    type: float
    default: 0.0
    unit: "deg/s"
    description: "Yaw angular rate in degrees/second (positive = clockwise)"
    # Limits defined in config_default.yaml SafetyLimits.MAX_YAW_RATE
    clamp: true

  # === Gimbal-specific Command Fields ===
  yaw_angle_deg:
    type: float
    default: 0.0
    unit: "deg"
    description: "Target yaw angle in degrees (NED offboard mode)"
    # Angle limits: -180 to 180 (full rotation)
    clamp: true

  # DEPRECATED: Use yawspeed_deg_s instead (typo variant)
  yaw_speed_deg_s:
    type: float
    default: 0.0
    unit: "deg/s"
    description: "[DEPRECATED] Use yawspeed_deg_s instead (this was a typo variant)"
    deprecated: true
    replacement: "yawspeed_deg_s"
    clamp: true

  # === Attitude Rate Control Fields (all in deg/s - MAVSDK standard) ===
  rollspeed_deg_s:
    type: float
    default: 0.0
    unit: "deg/s"
    description: "Roll angular rate in degrees/second"
    # Limits defined in config_default.yaml SafetyLimits
    clamp: true

  pitchspeed_deg_s:
    type: float
    default: 0.0
    unit: "deg/s"
    description: "Pitch angular rate in degrees/second"
    # Limits defined in config_default.yaml SafetyLimits
    clamp: true

  thrust:
    type: float
    default: 0.5
    unit: "normalized"
    description: "Thrust command (0.0 to 1.0)"
    # Thrust is always 0.0 to 1.0 (normalized)
    limits:
      min: 0.0
      max: 1.0
    clamp: true

# ==============================================================================
# Follower Profile Definitions
# ==============================================================================
# CLAMPING BEHAVIOR:
# Each field can specify 'clamp: true' to enable clamping to min/max limits.
# If 'clamp' is omitted, clamping defaults to true for safety.
# If 'clamp: false', out-of-range values will raise an error.
# This prevents silent zeroing and ensures predictable control.
#
# Example:
#   clamp: true   # Clamp values to min/max if out of range (recommended)
#   clamp: false  # Raise error if out of range
# Each profile defines which fields are used by that follower mode
follower_profiles:
  
  # Ground View Follower - Full velocity control for ground target tracking
  ground_view:
    display_name: "Ground View"
    description: "Full velocity control for tracking ground targets"
    control_type: "velocity_body"
    required_fields: ["vel_x", "vel_y", "vel_z"]
    optional_fields: []
    ui_category: "velocity"
    # Schema-driven tracker data requirements
    required_tracker_data: ["POSITION_2D"]
    optional_tracker_data: ["BBOX_CONFIDENCE", "VELOCITY_AWARE"]
    
  # Constant Distance Follower - Enhanced velocity control with yaw
  constant_distance:
    display_name: "Constant Distance"
    description: "Maintains constant distance while following target"
    control_type: "velocity_body_offboard"
    # Use MAVSDK-native body velocity fields and degrees/sec for yaw
    required_fields: ["vel_body_fwd", "vel_body_right", "vel_body_down", "yawspeed_deg_s"]
    optional_fields: []
    ui_category: "velocity"
    
  # Constant Position Follower - Limited movement, yaw and altitude only
  constant_position:
    display_name: "Constant Position"
    description: "Maintains position, only yaw and altitude control"
    control_type: "velocity_body_offboard"
    # Use MAVSDK-native body velocity fields and degrees/sec for yaw
    # vel_body_down is positive down; follower must negate its up-positive command
    required_fields: ["vel_body_down", "yawspeed_deg_s"]
    optional_fields: []
    ui_category: "velocity"
    
  # Chase Follower - Full attitude rate control for aggressive following
  chase_follower:
    display_name: "Chase Follower"
    description: "Aggressive following using attitude rate control"
    control_type: "attitude_rate"
    # All angular rates in deg/s (MAVSDK standard)
    required_fields: ["rollspeed_deg_s", "pitchspeed_deg_s", "yawspeed_deg_s", "thrust"]
    optional_fields: []
    ui_category: "attitude"

  # Body Velocity Chase Follower - Quadcopter offboard velocity control
  body_velocity_chase:
    display_name: "Body Velocity Chase"
    description: "Quadcopter chase using body velocity with forward ramp-up"
    control_type: "velocity_body_offboard"
    required_fields: ["vel_body_fwd", "vel_body_right", "vel_body_down"]
    optional_fields: ["yawspeed_deg_s"]
    ui_category: "velocity"
    # Schema-driven tracker data requirements
    required_tracker_data: ["POSITION_2D"]
    optional_tracker_data: ["BBOX_CONFIDENCE", "VELOCITY_AWARE", "MULTI_TARGET"]

  # Gimbal Follower - Unified NED/Body control from gimbal angles
  gimbal_unified:
    display_name: "Gimbal Follower"
    description: "Configurable NED/Body velocity control from gimbal angles"
    control_type: "velocity_body_offboard"  # Use body velocity offboard for body frame commands
    required_fields: ["vel_body_fwd", "vel_body_right", "vel_body_down"]
    optional_fields: ["yawspeed_deg_s"]
    ui_category: "gimbal"
    # Schema-driven tracker data requirements
    required_tracker_data: ["GIMBAL_ANGLES"]
    optional_tracker_data: ["ANGULAR", "POSITION_2D"]
    # Dynamic field configuration based on control mode
    ned_mode_fields: ["vel_x", "vel_y", "vel_z", "yaw_angle_deg"]
    body_mode_fields: ["vel_body_fwd", "vel_body_right", "vel_body_down", "yawspeed_deg_s"]

  # Gimbal Vector Body Follower - Direct vector pursuit using gimbal angles
  gimbal_vector_body:
    display_name: "Gimbal Vector (Body)"
    description: "Direct vector pursuit using gimbal angles and body frame velocity"
    control_type: "velocity_body_offboard"
    required_fields: ["vel_body_fwd", "vel_body_right", "vel_body_down"]
    optional_fields: ["yawspeed_deg_s"]
    ui_category: "gimbal"
    # Schema-driven tracker data requirements
    required_tracker_data: ["GIMBAL_ANGLES"]
    optional_tracker_data: ["ANGULAR", "POSITION_2D"]

# ==============================================================================
# Control Type Definitions
# ==============================================================================
# Maps control types to their corresponding MAVSDK methods
control_types:
  velocity_body:
    mavsdk_method: "set_velocity_body"
    description: "Body frame velocity commands"
    ui_display: "Velocity Control"
    
  attitude_rate:
    mavsdk_method: "set_attitude_rate"  
    description: "Attitude rate commands"
    ui_display: "Attitude Rate Control"

  velocity_body_offboard:
    mavsdk_method: "set_velocity_body_offboard"
    description: "Offboard body velocity commands for quadcopters"
    ui_display: "Body Velocity Offboard"

  dynamic:
    mavsdk_method: "dynamic"
    description: "Dynamic control type set at runtime"
    ui_display: "Dynamic Control"

# ==============================================================================
# UI Configuration
# ==============================================================================
# Configuration for dashboard auto-discovery and display
ui_config:
  # All angular rates use deg/s naming convention
  field_display_order: ["vel_x", "vel_y", "vel_z", "vel_body_fwd", "vel_body_right", "vel_body_down", "yawspeed_deg_s", "yaw_angle_deg", "rollspeed_deg_s", "pitchspeed_deg_s", "thrust"]

  field_groups:
    velocity:
      name: "Velocity Control"
      fields: ["vel_x", "vel_y", "vel_z"]
      color: "#2196F3"

    body_velocity:
      name: "Body Velocity Offboard"
      fields: ["vel_body_fwd", "vel_body_right", "vel_body_down", "yawspeed_deg_s"]
      color: "#4CAF50"

    attitude:
      name: "Attitude Rate Control"
      # All angular rates in deg/s (MAVSDK standard)
      fields: ["rollspeed_deg_s", "pitchspeed_deg_s", "yawspeed_deg_s", "thrust"]
      color: "#FF5722"

    gimbal:
      name: "Gimbal Control"
      fields: ["yaw_angle_deg", "yawspeed_deg_s"]
      color: "#9C27B0"

  profile_display_order: ["ground_view", "constant_distance", "constant_position", "chase_follower", "body_velocity_chase", "gimbal_unified", "gimbal_vector_body"]

# ==============================================================================
# Validation Rules
# ==============================================================================
# Additional validation rules beyond basic field limits
# All angular rate fields use deg/s (MAVSDK standard)
validation_rules:
  # Ensure attitude rate fields are only used with attitude control
  attitude_rate_exclusive:
    description: "Attitude rate fields can only be used with attitude_rate control type"
    # All angular rates in deg/s naming convention
    fields: ["rollspeed_deg_s", "pitchspeed_deg_s", "thrust"]
    allowed_control_types: ["attitude_rate"]

  # Ensure velocity fields are not mixed with attitude rate inappropriately
  velocity_exclusive:
    description: "Velocity fields should primarily be used with velocity_body control"
    fields: ["vel_x", "vel_y", "vel_z"]
    preferred_control_types: ["velocity_body"]

  # Ensure body velocity fields are used with appropriate control type
  body_velocity_exclusive:
    description: "Body velocity fields should be used with velocity_body_offboard control type"
    fields: ["vel_body_fwd", "vel_body_right", "vel_body_down", "yawspeed_deg_s"]
    allowed_control_types: ["velocity_body_offboard"]