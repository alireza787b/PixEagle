# ==============================================================================
# PixEagle Configuration File - Gimbal Testing Profile
# ==============================================================================
# GIMBAL TESTING - For SIP gimbal tracker + GM_VELOCITY_VECTOR follower
#    - Video: RTSP from gimbal camera (192.168.144.110)
#    - Tracker: Gimbal (external SIP gimbal system)
#    - Follower: gm_velocity_vector (direct vector pursuit)
#    - Velocities: Very slow (0.3 m/s max) for safe testing
#    - Altitude control: ENABLED for 3D pursuit
#
# USAGE: Copy this file to config.yaml on the flight device
# TESTING ORDER: Gimbal tracker -> gm_velocity_unified -> USB + mc_velocity_chase
# ==============================================================================




# ==============================================================================
# PRIMARY VIDEO INPUT CONFIGURATION (Top Priority)
# ==============================================================================
VideoSource:
  # Primary video source selection
  # Options: VIDEO_FILE, USB_CAMERA, RTSP_OPENCV, RTSP_STREAM, UDP_STREAM, HTTP_STREAM, CSI_CAMERA, CUSTOM_GSTREAMER
  VIDEO_SOURCE_TYPE: RTSP_STREAM
  
  # === Universal Capture Parameters (Applied to ALL sources) ===
  # üîß These ensure consistent processing regardless of input type
  CAPTURE_WIDTH: 640          # Width in pixels (lower = less CPU)
  CAPTURE_HEIGHT: 480         # Height in pixels 
  CAPTURE_FPS: 30            # Target FPS (actual may vary by source)
  DEFAULT_FPS: 30            # Fallback if source doesn't report FPS
  
  # === Performance Optimization ===
  # Enable for Raspberry Pi, Jetson, or low-power systems
  USE_GSTREAMER: true        # true = Use GStreamer pipelines (better for embedded)
  
  # === Source-Specific Parameters ===
  # Video file source
  VIDEO_FILE_PATH: resources/test4.mp4
  
  # USB Camera (webcam)
  CAMERA_INDEX: 0            # 0=first camera, 1=second, etc.
  
  # Network streams - Gimbal camera
  RTSP_URL: rtsp://192.168.144.110:554/stream=0

  # RTSP Protocol Settings
  # -----------------------
  # RTSP_PROTOCOL: Transport protocol for RTSP stream
  #   - tcp: More reliable, prevents packet loss (RECOMMENDED for most setups)
  #   - udp: Lower latency but may have packet loss on congested networks
  #   - auto: Let GStreamer choose (may fall back to UDP which can cause issues)
  # If you see "Invalid input packet" or "no frame!" errors, switch to tcp
  RTSP_PROTOCOL: tcp

  # RTSP_LATENCY: Buffer time in milliseconds
  #   - 200: Recommended for stable streaming (good balance)
  #   - 100: Lower latency, may drop frames on slow networks
  #   - 500: More stable for unreliable connections
  #   - 0: Minimum latency (may cause decoding errors, not recommended)
  RTSP_LATENCY: 200

  UDP_URL: udp://192.168.144.110:5000
  HTTP_URL: http://192.168.144.110:8100
  
  # CSI Camera (Raspberry Pi/Jetson camera)
  CSI_SENSOR_ID: 0          # Usually 0 for first CSI port
  
  # Custom GStreamer pipeline (advanced users)
  # Example: "videotestsrc ! video/x-raw,width=640,height=480 ! videoconvert ! appsink"
  CUSTOM_PIPELINE: ""
  
  # === Legacy Parameters (kept for compatibility) ===
  # DEPRECATED: Use CAPTURE_WIDTH/HEIGHT instead of CSI_WIDTH/HEIGHT
  STORE_LAST_FRAMES: 5      # Frame history buffer size

# ==============================================================================
# USB CAMERA OPTIMIZATION
# ==============================================================================
USBCamera:
  # Device path for Linux GStreamer (ignored on Windows)
  DEVICE_PATH: /dev/video0
  
  # Pixel format selection (impacts CPU usage)
  # YUYV = uncompressed (moderate CPU)
  # MJPG = compressed (lowest CPU, recommended for RPi)
  PIXEL_FORMAT: YUYV
  
  # OpenCV backend optimizations (when USE_GSTREAMER=false)
  USE_V4L2_BACKEND: false    # Linux only: direct V4L2 access
  OPENCV_BUFFER_SIZE: 1      # 1=lowest latency, 3=smoother
  OPENCV_FOURCC: ""          # Force codec: "MJPG", "H264", etc.

# ==============================================================================
# CSI CAMERA CONFIGURATION (Raspberry Pi/Jetson)
# ==============================================================================
Camera:  # Legacy name kept for compatibility
  # CSI-specific settings
  CSI_WIDTH: 640            # DEPRECATED: Use CAPTURE_WIDTH in VideoSource
  CSI_HEIGHT: 480           # DEPRECATED: Use CAPTURE_HEIGHT in VideoSource
  CSI_FRAMERATE: 30         # DEPRECATED: Use CAPTURE_FPS in VideoSource
  CSI_FLIP_METHOD: 0        # 0=none, 1=90¬∞CW, 2=180¬∞, 3=90¬∞CCW, 4=horizontal, 5=vertical

CSICamera:  # New section name (preferred)
  SENSOR_ID: 0              # Camera sensor ID
  FLIP_METHOD: 0            # Image rotation/flip

# ==============================================================================
# NETWORK CONFIGURATION (Connection Settings)
# ==============================================================================
PX4:
  # üöÅ PX4 Autopilot connection via MAVSDK
  EXTERNAL_MAVSDK_SERVER: true
  # For SITL: udp://127.0.0.1:14540
  # For companion computer: udp://127.0.0.1:14540  
  # For WSL: udp://172.21.148.30:14540 (use your WSL IP)
  SYSTEM_ADDRESS: udp://127.0.0.1:14540

MAVLink:
  # üì° MAVLink telemetry data source (MAVLink2REST)
  MAVLINK_ENABLED: true
  # For local: 127.0.0.1
  # For WSL: 172.21.148.30 (your WSL IP)
  MAVLINK_HOST: 127.0.0.1
  MAVLINK_PORT: 8088
  MAVLINK_POLLING_INTERVAL: 0.5    # Data refresh rate in seconds
  
  # Data points to fetch from MAVLink2REST API
  MAVLINK_DATA_POINTS:
    latitude: /vehicles/1/components/1/messages/GLOBAL_POSITION_INT/message/lat
    longitude: /vehicles/1/components/1/messages/GLOBAL_POSITION_INT/message/lon
    altitude_msl: /vehicles/1/components/1/messages/ALTITUDE/message/altitude_amsl
    altitude_agl: /vehicles/1/components/1/messages/ALTITUDE/message/altitude_relative
    voltage: /vehicles/1/components/1/messages/SYS_STATUS/message/voltage_battery
    airspeed: /vehicles/1/components/1/messages/VFR_HUD/message/airspeed
    throttle: /vehicles/1/components/1/messages/VFR_HUD/message/throttle
    groundspeed: /vehicles/1/components/1/messages/VFR_HUD/message/groundspeed
    climb: /vehicles/1/components/1/messages/VFR_HUD/message/climb
    vn: /vehicles/1/components/1/messages/LOCAL_POSITION_NED/message/vx
    ve: /vehicles/1/components/1/messages/LOCAL_POSITION_NED/message/vy
    vd: /vehicles/1/components/1/messages/LOCAL_POSITION_NED/message/vz
    flight_path_angle: null
    roll: /vehicles/1/components/1/messages/ATTITUDE/message/roll
    pitch: /vehicles/1/components/1/messages/ATTITUDE/message/pitch
    heading: /vehicles/1/components/1/messages/VFR_HUD/message/heading
    vdop: /vehicles/1/components/1/messages/GPS_RAW_INT/message/vdop
    hdop: /vehicles/1/components/1/messages/GPS_RAW_INT/message/hdop
    satellites_visible: /vehicles/1/components/1/messages/GPS_RAW_INT/message/satellites_visible
    flight_mode: /vehicles/1/components/1/messages/HEARTBEAT/message/custom_mode
    arm_status: /vehicles/1/components/1/messages/HEARTBEAT/message/base_mode


# ==============================================================================
# VIDEO STREAMING OUTPUT (Dashboard/Client) - ENHANCED
# ==============================================================================
Streaming:
  # üñ•Ô∏è Enable HTTP/WebSocket video streaming to web dashboard
  ENABLE_STREAMING: true
  
  # === Server Settings ===
  HTTP_STREAM_HOST: 0.0.0.0      # 0.0.0.0 = all interfaces
  HTTP_STREAM_PORT: 5077          # Web dashboard port
  
  # === Stream Quality Settings ===
  STREAM_WIDTH: 640               # Output resolution
  STREAM_HEIGHT: 480              
  STREAM_FPS: 10                  # Target FPS (actual may vary)
  STREAM_QUALITY: 50              # Default JPEG quality (0-100)
  STREAM_PROCESSED_OSD: true      # Include overlays
  
  
  # === Frame Buffering ===
  ENABLE_FRAME_CACHE: true        # Cache encoded frames
  CACHE_TTL_MS: 100              # Cache time-to-live in ms
  MAX_FRAME_QUEUE: 3             # Max queued frames per client
  
  # === WebSocket Settings ===
  WS_MAX_CONNECTIONS: 10         # Max concurrent WebSocket clients
  WS_ENABLE_COMPRESSION: false   # Enable WebSocket compression
  

   # Adaptive Quality Control
  ENABLE_ADAPTIVE_QUALITY: true    # Set true for auto quality adjustment
  MIN_QUALITY: 30                   # Minimum JPEG quality (1-100)
  MAX_QUALITY: 85                   # Maximum JPEG quality (1-100)
  QUALITY_STEP: 10                  # Quality adjustment step size
  
  # Frame Caching (reduces CPU usage)
  ENABLE_FRAME_CACHE: true         # Set true to cache encoded frames
  CACHE_TTL_MS: 100                # Cache time-to-live in milliseconds
  SKIP_IDENTICAL_FRAMES: true     # Skip encoding if frame unchanged
  
  # Connection Limits
  HTTP_MAX_CONNECTIONS: 20         # Max concurrent HTTP streams
  WS_MAX_CONNECTIONS: 10           # Max concurrent WebSocket clients
  MAX_FRAME_QUEUE: 3               # Max queued frames per WebSocket client
  HTTP_CHUNK_SIZE: 65536         # Chunk size for streaming

  
  # === Performance ===
  ENCODING_THREADS: 2            # Parallel encoding threads
  ENABLE_HARDWARE_ENCODING: false # Use hardware encoder if available
  SKIP_IDENTICAL_FRAMES: true    # Skip encoding if frame unchanged
  FRAME_DIFFERENCE_THRESHOLD: 5  # Pixel difference threshold
  
  # === H.264 Streaming (Advanced) ===
  ENABLE_H264_STREAM: false      # Enable H.264/WebRTC streaming
  H264_BITRATE: 1000000          # H.264 bitrate (bps)
  H264_PROFILE: baseline         # H.264 profile (baseline/main/high)
  H264_PRESET: ultrafast         # Encoding preset

# ==============================================================================
# üéØ TRACKING MODE CONFIGURATION
# ==============================================================================
Tracking:
  # === Algorithm Selection ===
  # Options: CSRT (recommended for rotation), KCF (fast), dlib (very fast), Gimbal (external)
  # CSRT: Best for drone circling, rotation, perspective changes (15-20 FPS, 85% accuracy)
  # KCF:  Fast alternative for high-speed scenarios (25-30 FPS, 75% accuracy)
  # dlib: Very fast correlation filter with PSR confidence (25-30 FPS, 85% accuracy)
  # Gimbal: External SIP gimbal system (receives tracking from camera UI)
  DEFAULT_TRACKING_ALGORITHM: Gimbal

  # === Global Visualization ===
  TRACKING_RECTANGLE_COLOR: [255, 0, 0]    # BGR: Blue
  CENTER_CIRCLE_COLOR: [0, 255, 0]         # BGR: Green
  CENTER_HISTORY_LENGTH: 10                # Trail length

  # === Global Tracking Limits ===
  MAX_DISPLACEMENT_THRESHOLD: 0.25         # Max jump as fraction of frame
  TRACKING_FAILURE_TIMEOUT: 5.0            # Seconds before re-detection
  REDETECTION_ATTEMPTS: 5                  # Max re-detection attempts

  # === Legacy Appearance Model (Deprecated - use tracker-specific configs) ===
  CONFIDENCE_THRESHOLD: 0.6                # ‚ö†Ô∏è Deprecated: Use tracker-specific
  APPEARANCE_THRESHOLD: 0.3
  APPEARANCE_CONFIDENCE_THRESHOLD: 0.5
  MOTION_CONFIDENCE_WEIGHT: 0.5
  APPEARANCE_CONFIDENCE_WEIGHT: 0.5
  CSRT_APPEARANCE_LEARNING_RATE: 0.05      # Deprecated: See CSRT_Tracker section

  # Motion consistency threshold for base tracker
  MOTION_CONFIDENCE_THRESHOLD: 0.7         # Minimum confidence from motion consistency check
  
  # === Particle Filter Parameters (if using) ===
  PF_NUM_PARTICLES: 500                    # More = accurate but slower
  PF_INIT_POS_STD: 20.0                   # Initial position uncertainty
  PF_INIT_VEL_STD: 5.0                    # Initial velocity uncertainty
  PF_INIT_ACC_STD: 1.0                    # Initial acceleration uncertainty
  PF_POS_STD: 15.0                        # Process noise for position
  PF_VEL_STD: 5.0                         # Process noise for velocity
  PF_ACC_STD: 1.0                         # Process noise for acceleration
  PF_APPEARANCE_LIKELIHOOD_SCALE: 25.0    
  PF_APPEARANCE_LEARNING_RATE: 0.05       
  PF_COLOR_WEIGHT: 0.7                    # Color vs edge importance
  PF_EDGE_WEIGHT: 0.3
  PF_CANNY_THRESHOLD1: 50                 # Edge detection params
  PF_CANNY_THRESHOLD2: 150
  PF_EFFECTIVE_PARTICLE_NUM_THRESHOLD: 0.5
  PF_RANDOM_PARTICLE_RATIO: 0.1           # Random resampling ratio

  # === Target Aim Point ===
  DESIRE_AIM: [0, 0]                       # Desired aim point in frame [x, y] (normalized)

# ==============================================================================
# TRACKER SAFETY PARAMETERS (Global Settings)
# ==============================================================================
# Applied to ALL trackers for edge-case handling and robustness
TrackerSafety:
  # Boundary detection margin (pixels from frame edge)
  # Used to detect when target is near edge (causes filter corruption)
  BOUNDARY_MARGIN_PIXELS: 15             # Distance threshold for "near boundary" detection
                                         # Research: 10-20px margin recommended for 640x480

  # Confidence penalty for boundary targets
  ENABLE_BOUNDARY_PENALTY: true          # Apply confidence penalty near frame edges
  BOUNDARY_PENALTY_MIN: 0.5              # Minimum confidence multiplier at edge (0.0-1.0)

# Global boundary margin (for backward compatibility)
BOUNDARY_MARGIN_PIXELS: 15               # Global access for base_tracker.py

# ==============================================================================
# üéØ KCF TRACKER CONFIGURATION (Kernelized Correlation Filter + Kalman)
# ==============================================================================
# Best for: High-speed tracking, CPU-limited systems, fast targets
# Performance: 25-30 FPS, ~75% success rate
# Limitations: Poor rotation invariance, moderate scale changes only
#
# Tuning Guide:
# - Target lost easily? ‚Üí ‚Üì confidence_threshold, ‚Üë failure_threshold
# - Tracker too slow? ‚Üí ‚Üì appearance_learning_rate
# - Rotation issues? ‚Üí ‚Üë appearance_learning_rate, ‚Üë max_scale_change
# - Jittery tracking? ‚Üí ‚Üì confidence_smoothing (more smoothing)
# ==============================================================================
KCF_Tracker:
  # === Robustness Parameters (Research-Optimized) ===
  # ‚ÑπÔ∏è Based on MDPI 2021 "Long-Term Target Tracking of UAVs Based on KCF"
  # ‚úÖ Optimized for: High-speed aerial tracking with limited rotation

  confidence_threshold: 0.15             # Min confidence to accept (0.0-1.0)
                                         # Research: 0.15-0.25 optimal for aerial KCF tracking
                                         # KCF confidence scoring is less calibrated than CSRT
                                         # ‚úÖ TUNED: 0.15 (very tolerant) for fast race car tracking

  failure_threshold: 7                   # Consecutive failures before declaring lost
                                         # Research: 5-10 frames optimal for KCF UAV tracking
                                         # KCF suffers from boundary effects and filter corruption
                                         # ‚úÖ TUNED: 7 frames (~233ms at 30fps) handles boundary effects

  confidence_smoothing: 0.6              # EMA alpha (0.0-1.0)
                                         # Research: 0.5-0.7 optimal for KCF (more smoothing than CSRT)
                                         # Lower = more stable (filters noise), higher = more responsive
                                         # ‚úÖ TUNED: 0.6 for heavy smoothing of noisy KCF confidence

  # === Validation Limits ===
  max_scale_change_per_frame: 0.6        # Max size change per frame (0.0-1.0)
                                         # Research: KCF requires aggressive scale adaptation
                                         # 0.6 = 60% scale change allowed (generous for zoom)
                                         # ‚úÖ TUNED: 0.6 compensates for KCF's scale limitations

  max_motion_per_frame: 0.7              # Max motion as fraction of frame diagonal
                                         # Research: 0.6-0.8 optimal for high-speed aerial tracking
                                         # KCF's expanded search region (2.5x target size) allows this
                                         # ‚úÖ TUNED: 0.7 for high-speed targets with expanded search

  # === Appearance Adaptation ===
  appearance_learning_rate: 0.18         # Adaptive learning speed (0.0-1.0)
                                         # Research: 0.15-0.25 optimal for KCF aerial tracking
                                         # Higher = faster adaptation (compensates for rotation)
                                         # ‚úÖ TUNED: 0.18 (aggressive) for rotation tolerance

  # === Internal Kalman Filter Parameters ===
  # These control the internal 4D Kalman filter (state: x, y, vx, vy)
  kalman_process_noise: 0.1              # Process noise (Q matrix multiplier)
                                         # Lower = trust motion model more, higher = trust measurements
  kalman_velocity_noise_factor: 0.5      # Velocity noise relative to position noise
                                         # Lower = smoother velocity estimates
  kalman_measurement_noise: 5.0          # Measurement noise (R matrix, ~pixels)
                                         # Typical sensor uncertainty in pixels
  kalman_initial_covariance: 10.0        # Initial state covariance (P matrix)
                                         # Higher = less confident in initial state

  # === Motion Consistency Threshold (Research-Optimized) ===
  motion_consistency_threshold: 0.15     # Max motion as fraction of frame diagonal
                                         # Research: 0.7 (1541px on 640x480) is 6x too permissive
                                         # ‚úÖ TUNED: 0.15 (~120px) for accurate frame-to-frame validation

  # === Velocity-Based Occlusion Recovery ===
  use_velocity_during_occlusion: true    # Use Kalman velocity for position extrapolation
                                         # Improves recovery accuracy by 15-25%
  occlusion_velocity_factor: 0.5         # Conservative extrapolation (50% of velocity)
                                         # Prevents overshooting during occlusion

  # === Asymmetric Kalman Initial Covariance ===
  kalman_initial_position_covariance: 10.0   # Position: high confidence (known)
  kalman_initial_velocity_covariance: 100.0  # Velocity: low confidence (unknown at start)

  # === Research-Based Tuning Presets ===
  # üèéÔ∏è HIGH-SPEED RACE CARS (Current Config - Optimized):
  #   confidence_threshold: 0.15, failure_threshold: 7, appearance_learning_rate: 0.18
  #   confidence_smoothing: 0.6, max_motion_per_frame: 0.7
  #
  # üöÅ DRONE-TO-DRONE TRACKING:
  #   confidence_threshold: 0.12, failure_threshold: 10, appearance_learning_rate: 0.20
  #   max_scale_change_per_frame: 0.7, max_motion_per_frame: 0.8
  #
  # üíª CPU-LIMITED (Raspberry Pi):
  #   confidence_threshold: 0.20, failure_threshold: 5, appearance_learning_rate: 0.12
  #   confidence_smoothing: 0.5

# ==============================================================================
# üéØ CSRT TRACKER CONFIGURATION (Channel and Spatial Reliability Tracker)
# ==============================================================================
# Best for: Rotation, perspective changes, drone circling targets
# Performance: 15-20 FPS, ~85% success rate
# Strengths: Rotation-invariant, excellent scale adaptation, occlusion handling
#
# ==============================================================================
# üöÄ SIMPLE PERFORMANCE MODE - Choose based on your system:
# ==============================================================================
#
# "legacy"    - ORIGINAL CSRT (15-20 FPS) üîß CLASSIC
#               ‚úÖ Exact original implementation (proven stable)
#               ‚úÖ Zero overhead, maximum compatibility
#               ‚úÖ Always starts reliably when you click
#               ‚ö†Ô∏è May lose track during fast rotation/occlusions
#               Best for: Want original behavior, maximum speed
#
# "balanced"  - RECOMMENDED (12-18 FPS) ‚≠ê DEFAULT
#               ‚úÖ Reliable startup with grace period
#               ‚úÖ Smooth confidence tracking (EMA filtering)
#               ‚úÖ Good for drone circling targets
#               ‚úÖ Best speed/accuracy trade-off
#               Best for: Most use cases, general purpose
#
# "robust"    - PROFESSIONAL (10-15 FPS) üí™ ADVANCED
#               ‚úÖ Multi-frame failure tolerance
#               ‚úÖ Motion/scale validation against Kalman estimator
#               ‚úÖ Adaptive appearance learning
#               ‚úÖ Maximum stability during challenging scenarios
#               ‚ö†Ô∏è Requires more CPU resources
#               Best for: Critical missions, powerful hardware
#
# ==============================================================================
CSRT_Tracker:
  # === User-Friendly Performance Control (MAIN PARAMETER) ===
  performance_mode: "robust"           # Choose: "legacy", "balanced", or "robust"
                                         # ‚≠ê OPTIMIZED FOR: Aerial drone tracking race cars

  # === Advanced Parameters (Research-Optimized for Aerial Tracking) ===
  # ‚ÑπÔ∏è Based on IEEE 2020-2024 aerial tracking research
  # ‚úÖ Optimized for: Ground vehicles from aerial view, perspective changes

  confidence_threshold: 0.45             # Min confidence to accept (0.0-1.0)
                                         # Research: 0.4-0.5 optimal for aerial ground targets
                                         # Auto: legacy=0.6, balanced=0.5, robust=0.4
                                         # ‚úÖ TUNED: 0.45 for race car tracking (moderate tolerance)

  failure_threshold: 5                   # Consecutive failures before declaring lost
                                         # Research: 3-7 frames optimal for UAV tracking
                                         # ‚úÖ TUNED: 5 frames (~166ms at 30fps) handles transient occlusions

  confidence_smoothing: 0.7              # EMA alpha (0.0-1.0)
                                         # Research: 0.6-0.8 optimal for aerial platforms
                                         # ‚úÖ TUNED: 0.7 balances responsiveness with stability

  validation_start_frame: 10             # Grace period before validation starts
                                         # Research: 5-15 frames needed for filter convergence
                                         # ‚ö†Ô∏è Critical for reliable lock-on from user ROI selection
                                         # ‚úÖ TUNED: 10 frames (~333ms) for stable initialization

  max_scale_change_per_frame: 0.5        # Max size change per frame (0.0-1.0)
                                         # Research: 0.4-0.6 optimal for aerial zoom changes
                                         # ‚úÖ TUNED: 0.5 (50% change) handles altitude variations

  max_motion_per_frame: 0.6              # Max motion as fraction of frame diagonal
                                         # Research: 0.5-0.7 optimal for fast-moving targets
                                         # Accounts for: race car speed + drone camera motion
                                         # ‚úÖ TUNED: 0.6 for high-speed race car tracking

  appearance_learning_rate: 0.10         # Adaptive learning speed (0.0-1.0)
                                         # Research: 0.08-0.15 optimal for aerial tracking
                                         # ‚úÖ TUNED: 0.10 for gradual appearance adaptation

  # === OpenCV CSRT Advanced Parameters (CVPR 2017 Research-Optimized) ===
  # These configure the internal OpenCV CSRT algorithm for improved accuracy
  use_color_names: true                  # ColorNames features (+5-8% accuracy for colored targets)
  use_hog: true                          # HOG features (essential for shape-based tracking)
  csrt_learning_rate: 0.02               # Filter learning rate (0.02 faster than default 0.015)
  number_of_scales: 33                   # Scale pyramid levels (33 for finer scale precision)
  scale_step: 1.02                       # Scale factor between levels (1.02 for smooth adaptation)
  use_segmentation: true                 # Foreground/background segmentation

  # === Appearance Model Drift Protection ===
  appearance_update_min_confidence: 0.55  # Only update appearance when conf > this
                                         # Prevents template corruption during occlusions

  # === Multi-Frame Validation Consensus ===
  enable_multiframe_validation: true     # Require N consecutive valid frames
  validation_consensus_frames: 3         # Frames required for consensus

# ==============================================================================
# üéØ DLIB TRACKER CONFIGURATION (dlib Correlation Filter Tracker)
# ==============================================================================
# Best for: Fast tracking, high FPS requirements, CPU-constrained systems
# Performance: 25-30 FPS, ~85% success rate
# Strengths: Fast correlation filter, good out-of-the-box performance, PSR confidence
# Limitations: Limited rotation invariance, moderate occlusion handling
#
# Algorithm: Based on Danelljan et al. 2014 DSST (Discriminative Scale Space Tracker)
#            Built on Bolme et al. 2010 MOSSE (Minimum Output Sum of Squared Error)
#
# ==============================================================================
# üöÄ SIMPLE PERFORMANCE MODE - Choose based on your needs:
# ==============================================================================
#
# "fast"      - MAXIMUM SPEED (25-30 FPS) ‚ö° HIGH-FPS
#               ‚úÖ Minimal validation overhead
#               ‚úÖ Direct PSR-based confidence
#               ‚úÖ Best for high-speed targets
#               ‚ö†Ô∏è May lose track on rapid rotation
#               Best for: High FPS requirements, fast-moving targets
#
# "balanced"  - RECOMMENDED (18-25 FPS) ‚≠ê DEFAULT
#               ‚úÖ PSR confidence monitoring with smoothing
#               ‚úÖ Startup grace period for reliable tracking
#               ‚úÖ Good accuracy/speed trade-off
#               ‚úÖ Works well with aerial drone tracking
#               Best for: Most use cases, general purpose
#
# "robust"    - MAXIMUM STABILITY (12-18 FPS) üí™ ADVANCED
#               ‚úÖ Full motion/scale validation
#               ‚úÖ Kalman estimator cross-validation
#               ‚úÖ Adaptive appearance learning
#               ‚úÖ Best for challenging scenarios
#               ‚ö†Ô∏è Requires more CPU resources
#               Best for: Critical missions, powerful hardware
#
# ==============================================================================
DLIB_Tracker:
  # === User-Friendly Performance Control (MAIN PARAMETER) ===
  performance_mode: "robust"           # Choose: "fast", "balanced", or "robust"
                                         # ‚≠ê OPTIMIZED FOR: Aerial drone tracking (race cars & drones)

  # === PSR-Based Confidence System (Research-Optimized) ===
  # PSR (Peak-to-Sidelobe Ratio) - THE standard metric for correlation filters
  # Based on Bolme et al. 2010 MOSSE research (validated across hundreds of papers):
  #   PSR < 5: Poor tracking (occlusion or loss)
  #   PSR 5-7: Marginal tracking
  #   PSR 7-20: Good tracking (reliable)
  #   PSR > 20: Excellent tracking

  psr_confidence_threshold: 7.0          # Min PSR for reliable tracking
                                         # Research: PSR = 7.0 recommended by Bolme et al. (CVPR 2010)
                                         # Aerial tracking: 5.0-8.0 optimal range
                                         # Auto: fast=5.0, balanced=7.0, robust=7.0
                                         # ‚úÖ TUNED: 7.0 (research standard) for balanced reliability

  psr_high_confidence: 20.0              # PSR above this = excellent tracking
                                         # Research: PSR > 20 indicates very strong correlation peak
                                         # ‚úÖ TUNED: 20.0 (research standard) for normalization

  psr_low_confidence: 5.0                # PSR below this = poor tracking
                                         # Research: PSR < 5 indicates occlusion or tracking failure
                                         # Auto: fast=3.0, balanced=5.0, robust=5.0
                                         # ‚úÖ TUNED: 5.0 (research standard) for failure detection

  # === Failure Tolerance ===
  failure_threshold: 5                   # Consecutive failures before declaring lost
                                         # Research: 3-7 frames optimal for correlation filters
                                         # Auto: fast=3, balanced=5, robust=5
                                         # ‚úÖ TUNED: 5 frames (balances robustness with responsiveness)

  confidence_smoothing_alpha: 0.7        # EMA (Exponential Moving Average) alpha
                                         # Research: 0.6-0.8 optimal for aerial platforms
                                         # Only used in balanced/robust modes
                                         # ‚úÖ TUNED: 0.7 for balanced PSR smoothing

  # === Validation & Robustness (Robust Mode Only) ===
  validation_start_frame: 10             # Grace period before validation starts
                                         # Research: 5-15 frames for MOSSE/DSST convergence
                                         # ‚ö†Ô∏è Critical for reliable startup!
                                         # Auto: fast=999999, balanced=10, robust=5
                                         # ‚úÖ TUNED: 10 frames (~333ms at 30fps)

  max_scale_change_per_frame: 0.5        # Max size change per frame (0.0-1.0)
                                         # Research: 0.4-0.6 optimal for aerial tracking
                                         # DSST uses 33 scale levels with factor a=1.02 (research std)
                                         # ‚úÖ TUNED: 0.5 for moderate aerial zoom tolerance

  max_motion_per_frame: 0.6              # Max motion as fraction of frame diagonal
                                         # Research: 0.5-0.7 optimal for fast targets
                                         # MOSSE achieves hundreds of FPS, can handle fast motion
                                         # ‚úÖ TUNED: 0.6 for high-speed race car tracking

  # === Appearance Adaptation ===
  appearance_learning_rate: 0.08         # Template update learning rate (0.0-1.0)
                                         # Research: 0.08-0.15 optimal for aerial tracking
                                         # DSST research: spatial filter Œ∑=0.012, scale filter Œ∑=0.025
                                         # Auto: fast=0.08, balanced=0.08, robust=0.08
                                         # ‚úÖ TUNED: 0.08 for balanced adaptation (slightly conservative)

  # === Template Matching Re-detection Integration ===
  enable_template_redetection: true      # Use template matching for recovery
                                         # Research: Multi-scale NCC for re-detection (UAV tracking papers)
                                         # ‚úÖ RECOMMENDED: true for robust tracking

  redetection_psr_threshold: 5.0         # Trigger re-detection below this PSR
                                         # Research: Should match psr_low_confidence threshold
                                         # ‚úÖ TUNED: 5.0 (matches research standard for failure)

  # ==============================================================================
  # üî¨ ADVANCED FEATURES (Enhanced Robustness & Adaptability)
  # ==============================================================================
  # The following features implement state-of-the-art correlation filter techniques
  # based on recent research in adaptive tracking and template management

  # === Adaptive PSR System (Dynamic Threshold Adjustment) ===
  # Automatically adjusts PSR thresholds based on tracking history
  # Research: Adaptive thresholding improves robustness in varying conditions
  # Reference: Zhang et al. "Adaptive Correlation Filters with Long-Term and Short-Term Memory" IJCV 2018
  adaptive:
    enable: true                         # Enable adaptive PSR threshold system
                                         # ‚úÖ RECOMMENDED: true for varying lighting/appearance
                                         # Performance: ~2-3% CPU overhead in robust mode

    psr_dynamic_scaling: true            # Adjust PSR thresholds dynamically
                                         # true = thresholds adapt to recent tracking quality
                                         # false = use static thresholds from config
                                         # ‚úÖ TUNED: true for challenging scenarios

    adapt_rate: 0.15                     # Rate of threshold adaptation (0.0-1.0)
                                         # Higher = faster adaptation to new conditions
                                         # Lower = more stable, less reactive
                                         # Research: 0.10-0.20 optimal range
                                         # ‚úÖ TUNED: 0.15 for balanced adaptation speed

    psr_margin: 1.5                      # Safety margin for adaptive thresholds
                                         # Prevents thresholds from becoming too aggressive
                                         # Multiplier applied to adapted threshold
                                         # ‚úÖ TUNED: 1.5 for conservative adaptation

  # === Enhanced Appearance Model (Smart Template Management) ===
  # Advanced template update strategies for long-term tracking stability
  # Research: Adaptive learning prevents template drift and corruption
  # Reference: Danelljan et al. "Learning Spatially Regularized Correlation Filters" ICCV 2015
  appearance:
    use_adaptive_learning: true          # Dynamic learning rate based on confidence
                                         # High PSR = faster learning, Low PSR = slower/frozen
                                         # ‚úÖ RECOMMENDED: true for production systems
                                         # Prevents template corruption during occlusions

    adaptive_learning_bounds: [0.05, 0.15]  # [min, max] learning rate range
                                         # Learning rate scales between these bounds
                                         # based on current confidence/PSR
                                         # Research: 0.05-0.20 typical range
                                         # ‚úÖ TUNED: [0.05, 0.15] for aerial tracking

    freeze_on_low_confidence: true       # Stop template updates when PSR low
                                         # Critical for preventing drift during occlusions
                                         # Freezes updates when PSR < psr_low_confidence
                                         # ‚úÖ CRITICAL: true for robust tracking
                                         # Research: Standard practice in production trackers

    reference_update_interval: 30        # Frames between reference template refresh
                                         # Periodic refresh prevents long-term drift
                                         # 0 = disabled, 30 = refresh every 30 frames
                                         # Research: 20-50 frames typical for 30fps video
                                         # ‚úÖ TUNED: 30 frames (~1 second at 30fps)

  # === Enhanced Motion Model (Stability & Validation) ===
  # Advanced motion filtering and validation for smooth, reliable tracking
  # Research: Temporal consistency improves tracking in noisy conditions
  motion:
    velocity_limit: 25.0                 # Max velocity magnitude (pixels/frame)
                                         # Safety limit for unrealistic motion detection
                                         # Should be tuned to expected max target speed
                                         # Research: Resolution-dependent, ~10-50 px/frame
                                         # ‚úÖ TUNED: 25.0 for 640x480 @ 30fps racing scenarios

    # === Velocity Normalization by Target Size ===
    velocity_normalize_by_size: true     # Normalize velocity limit by target diagonal
                                         # Makes validation resolution-agnostic
    max_velocity_target_factor: 2.0      # Max velocity = N * target diagonal per frame

    stabilization_alpha: 0.3             # EMA smoothing for bbox position (0.0-1.0)
                                         # Reduces jitter in tracking output
                                         # Lower = more smoothing, Higher = more responsive
                                         # Research: 0.2-0.4 optimal for aerial platforms
                                         # ‚úÖ TUNED: 0.3 for balanced smoothing
                                         # Note: Separate from confidence_smoothing_alpha

  # === Enhanced Validation (Recovery & Resilience) ===
  # Smart validation and recovery mechanisms for handling tracking loss
  validation:
    reinit_on_loss: true                 # Auto-reinitialize tracker on failure
                                         # Uses template matching for recovery
                                         # Requires enable_template_redetection=true
                                         # ‚úÖ RECOMMENDED: true for autonomous systems

    cooldown_after_reinit: 5             # Grace period after reinitialization (frames)
                                         # Allows tracker to stabilize after recovery
                                         # Skips validation during this period
                                         # ‚úÖ TUNED: 5 frames (~166ms at 30fps)

  # === Debug & Visualization (Development Aid) ===
  # Visual feedback for tracking quality monitoring
  debug:
    enable_visual_feedback: true         # Draw confidence/PSR overlay on video
                                         # Shows real-time tracking quality metrics
                                         # Performance: ~1-2ms overhead

    show_motion_vectors: false           # Display motion prediction arrows
                                         # Visualizes Kalman estimator predictions
                                         # Useful for debugging motion validation

  # ==============================================================================
  # üéØ TUNING GUIDE FOR DIFFERENT SCENARIOS
  # ==============================================================================
  #
  # üöÄ HIGH-SPEED TARGETS (>10 m/s):
  #   performance_mode: "fast"
  #   psr_confidence_threshold: 5.0
  #   failure_threshold: 3
  #   max_motion_per_frame: 0.8
  #   appearance_learning_rate: 0.15
  #
  # üîÑ ROTATING TARGETS (Drone circling):
  #   performance_mode: "robust"
  #   appearance_learning_rate: 0.15
  #   max_scale_change_per_frame: 0.6
  #   enable_template_redetection: true
  #
  # üíª RESOURCE-CONSTRAINED (Raspberry Pi):
  #   performance_mode: "fast"
  #   psr_confidence_threshold: 6.0
  #   confidence_smoothing_alpha: 0.5  # Less computation
  #
  # üõ°Ô∏è CRITICAL MISSIONS (Maximum Reliability):
  #   performance_mode: "robust"
  #   failure_threshold: 7
  #   psr_confidence_threshold: 8.0
  #   validation_start_frame: 5
  #   enable_template_redetection: true
  #
  # üé• OCCLUSION-PRONE SCENES:
  #   performance_mode: "robust"
  #   failure_threshold: 7
  #   enable_template_redetection: true
  #   redetection_psr_threshold: 6.0
  #
  # ==============================================================================

# ==============================================================================
# SMART TRACKER (YOLO-based AI Tracking)
# ==============================================================================
SmartTracker:
  # ü§ñ Enable AI-powered object tracking
  SMART_TRACKER_ENABLED: true

  # === Hardware Selection ===
  SMART_TRACKER_USE_GPU: true              # Try GPU first (CUDA)
  SMART_TRACKER_FALLBACK_TO_CPU: true      # Fall back if GPU fails

  # === Model Paths ===
  # üìÅ Use add_yolo_model.py to download/convert models
  # Simply replace these paths with your custom-trained YOLO model
  SMART_TRACKER_GPU_MODEL_PATH: "yolo/yolo11n.pt"          # PyTorch model
  SMART_TRACKER_CPU_MODEL_PATH: "yolo/yolo11n_ncnn_model"  # Optimized for ARM

  # === Detection Parameters ===
  SMART_TRACKER_CONFIDENCE_THRESHOLD: 0.3   # Min detection confidence (0.0-1.0)
  SMART_TRACKER_IOU_THRESHOLD: 0.3          # Overlap threshold for NMS (0.0-1.0)
  SMART_TRACKER_MAX_DETECTIONS: 20          # Max objects per frame

  # === Visual Settings ===
  SMART_TRACKER_COLOR: [0, 255, 255]        # BGR: Yellow
  SMART_TRACKER_SHOW_FPS: false

  # ==============================================================================
  # üéØ TRACKER TYPE SELECTION (Choose Your Tracking Strategy)
  # ==============================================================================
  #
  # üìä DECISION GUIDE:
  #
  # GPU System + Internet Access + Long Occlusions:
  #   ‚Üí Use "botsort_reid" (best accuracy, Ultralytics native ReID)
  #
  # CPU System / Raspberry Pi + Long Occlusions:
  #   ‚Üí Use "custom_reid" (lightweight, works offline, good re-ID on CPU)
  #
  # Air-gapped / Offline Drone:
  #   ‚Üí Use "custom_reid" (no internet needed, fully offline)
  #
  # High FPS Required (>30 FPS):
  #   ‚Üí Use "bytetrack" (fastest, disable ReID for maximum speed)
  #
  # Balanced Performance + Better Persistence:
  #   ‚Üí Use "botsort" (better than ByteTrack, no ReID overhead)
  #
  # üìä PERFORMANCE COMPARISON:
  #
  # Tracker Type    | FPS Impact | ReID Quality | Offline | GPU Needed | Ultralytics v8.3.114+
  # ----------------|------------|--------------|---------|------------|----------------------
  # bytetrack       | 0%         | None         | ‚úì       | No         | Any version
  # botsort         | -3-5%      | Low          | ‚úì       | No         | Any version
  # botsort_reid    | -5-8%      | Excellent    | ‚úó       | Recommended| Required
  # custom_reid     | -8-12%     | Good         | ‚úì       | No         | Any version
  #
  TRACKER_TYPE: "botsort_reid"

  # Options:
  # - "bytetrack": Fast, no ReID, geometric matching only
  # - "botsort": Better persistence, no ReID, geometric + better association
  # - "botsort_reid": BoT-SORT + Ultralytics native ReID (RECOMMENDED for GPU)
  # - "custom_reid": Lightweight histogram/HOG ReID (RECOMMENDED for CPU/offline)

  # ==============================================================================
  # ü§ñ BOT-SORT RE-IDENTIFICATION (Ultralytics Native ReID)
  # ==============================================================================
  # Only used when TRACKER_TYPE = "botsort_reid"
  # Requires Ultralytics v8.3.114+ (will auto-fallback to custom_reid if unavailable)

  # ReID embedding model selection
  # "auto": Uses native YOLO features (fastest, zero overhead, RECOMMENDED)
  # "yolo11n-cls.pt": Classification model (better accuracy, +2-5ms latency)
  # Custom path: Your own ReID embedding model
  BOTSORT_REID_MODEL: "auto"

  # Appearance similarity threshold for ReID matching
  # Lower = stricter matching (fewer false positives, may miss correct matches)
  # Higher = more lenient (more false positives, better recall)
  # ‚ö†Ô∏è NOTE: Opposite direction from APPEARANCE_MATCH_THRESHOLD!
  # Recommended: 0.20-0.30
  BOTSORT_APPEARANCE_THRESH: 0.25

  # IoU (geometric proximity) threshold for matching
  # Works alongside appearance threshold
  # Recommended: 0.4-0.6
  BOTSORT_PROXIMITY_THRESH: 0.5

  # Number of frames to remember lost tracks (for re-identification)
  # Higher = can recover after longer occlusions (uses more memory)
  # Recommended: 30-120 frames
  # 30 ‚âà 1 second, 60 ‚âà 2 seconds, 120 ‚âà 4 seconds at 30 FPS
  BOTSORT_TRACK_BUFFER: 60

  # IoU threshold for matching detections to existing tracks
  # Higher = stricter (fewer ID switches)
  # Lower = more lenient (better recovery)
  # Recommended: 0.7-0.9
  BOTSORT_MATCH_THRESH: 0.8

  # High confidence detection threshold (first association pass)
  # Recommended: 0.20-0.30
  BOTSORT_TRACK_HIGH_THRESH: 0.25

  # Low confidence detection threshold (recovery pass)
  # Recommended: 0.05-0.15
  BOTSORT_TRACK_LOW_THRESH: 0.1

  # Minimum confidence for creating new tracks
  # Lower = easier to start tracking
  # Higher = only track high-confidence objects
  # Recommended: 0.20-0.30
  BOTSORT_NEW_TRACK_THRESH: 0.25

  # Fuse detection confidence with IoU during matching
  # true = better discrimination (recommended)
  # false = pure geometric matching
  BOTSORT_FUSE_SCORE: true

  # Camera motion compensation method
  # "sparseOptFlow": Optical flow-based (recommended)
  # "none": Disable (use if camera is stationary)
  BOTSORT_CMC_METHOD: "sparseOptFlow"

  # ==============================================================================
  # üéØ ID TRACKING ROBUSTNESS (Hybrid Strategy - Works with All Tracker Types)
  # ==============================================================================
  # These parameters make tracking more robust when objects temporarily disappear
  # or when YOLO assigns new IDs to the same object

  # === Tracking Strategy ===
  # How to match tracked object across frames when ID changes
  # - "id_only": Strict ID matching (fastest, but loses track on ID change)
  # - "spatial_only": Position-based matching using IoU (works without IDs)
  # - "hybrid": ID first, falls back to spatial matching (RECOMMENDED)
  TRACKING_STRATEGY: "hybrid"

  # === ID Loss Tolerance ===
  # Number of frames to maintain tracking after losing track ID
  # Useful when object is briefly occluded or detector misses 1-2 frames
  # Higher = more forgiving, Lower = stricter (re-select needed sooner)
  # Recommended: 5-10 frames for drone tracking
  ID_LOSS_TOLERANCE_FRAMES: 5

  # === Graceful Degradation (Robustness Enhancement) ===
  # Multi-level fallback strategy when YOLO detection fails
  ENABLE_GRACEFUL_DEGRADATION: true      # Enable multi-level fallback chain
  EXTENDED_TOLERANCE_FRAMES: 10          # Additional frames beyond ID_LOSS_TOLERANCE
                                         # During this period: lenient matching + prediction-only mode

  # === Track Confidence Aging ===
  TRACK_CONFIDENCE_DECAY_RATE: 0.05      # Decay rate per frame without detection (5%)
                                         # Old unconfirmed tracks have lower confidence

  # === Appearance Model Memory Cap ===
  MAX_LOST_OBJECTS_CACHED: 100           # Maximum objects in re-ID memory
                                         # Prevents unbounded memory growth

  # === Spatial Matching ===
  # IoU threshold for matching by position when ID is lost
  # Higher = stricter matching (less false positives)
  # Lower = more lenient (might match wrong object)
  # Range: 0.0-1.0, Recommended: 0.3-0.5
  SPATIAL_IOU_THRESHOLD: 0.35

  # === Motion Prediction ===
  # Use velocity-based prediction to estimate object location during occlusion
  # Helps find object even if it moves while temporarily invisible
  # true = more robust to occlusions, false = simpler/faster
  ENABLE_PREDICTION_BUFFER: true

  # === Confidence Smoothing ===
  # Apply exponential moving average to detection confidence
  # Reduces jitter from frame-to-frame confidence variations
  # Higher = more smoothing, Lower = more responsive
  # Range: 0.0-1.0, Recommended: 0.7-0.9
  CONFIDENCE_SMOOTHING_ALPHA: 0.8

  # ==============================================================================
  # üîß BYTETRACK ADVANCED TUNING
  # ==============================================================================
  # These parameters control ByteTrack's internal tracking behavior
  # Normally you don't need to change these, but they're here for fine-tuning

  # === Track Persistence ===
  # Number of frames to keep track alive after losing detection
  # Higher = tracks survive longer occlusions
  # Lower = faster cleanup of lost tracks
  # Default: 30, Recommended for robust tracking: 50
  BYTETRACK_TRACK_BUFFER: 50

  # === Track Matching ===
  # IoU threshold for matching detections to existing tracks
  # Higher = stricter matching (less ID switches)
  # Lower = more lenient (may cause ID switches)
  # Range: 0.0-1.0, Recommended: 0.8
  BYTETRACK_MATCH_THRESH: 0.8

  # === New Track Creation ===
  # Confidence threshold for creating new tracks from detections
  # Lower = easier to start tracking new objects (good for re-acquisition)
  # Higher = only track high-confidence detections (fewer false positives)
  # Range: 0.0-1.0, Recommended: 0.20-0.25
  BYTETRACK_NEW_TRACK_THRESH: 0.20

  # === High/Low Confidence Thresholds ===
  # ByteTrack uses two-stage association (high conf ‚Üí low conf)
  # High threshold: First association pass (confident detections)
  # Low threshold: Second association pass (recover lost tracks)
  BYTETRACK_TRACK_HIGH_THRESH: 0.25
  BYTETRACK_TRACK_LOW_THRESH: 0.1

  # === Score Fusion ===
  # Combine detection confidence with IoU distance during matching
  # true = better handling of similar objects
  # false = pure geometric matching
  BYTETRACK_FUSE_SCORE: true

  # ==============================================================================
  # üé® APPEARANCE-BASED RE-IDENTIFICATION (Advanced Feature)
  # ==============================================================================
  # Enables object re-identification after long occlusions using visual appearance
  # Useful when object disappears for >5 frames and returns with different ID
  # Maintains original track ID even after long disappearances

  # === Feature Toggle ===
  # Set to false on low-performance boards (Raspberry Pi Zero, older ARM)
  # Adds ~5-10ms per frame overhead on modern hardware
  ENABLE_APPEARANCE_MODEL: true

  # === Similarity Threshold ===
  # How similar appearances must be to consider a match (0.0-1.0)
  # Higher = stricter matching (fewer false positives, may miss correct matches)
  # Lower = more lenient (more false positives, better recall)
  # Recommended values:
  #   - 0.8-0.9: Very strict (use when objects look very similar)
  #   - 0.6-0.7: Balanced (recommended for most scenarios)
  #   - 0.4-0.5: Lenient (use when lighting/angle changes dramatically)
  APPEARANCE_MATCH_THRESHOLD: 0.7

  # === Feature Extraction Method ===
  # Determines what visual features are used for matching
  # "histogram": Fast, color-based matching
  #   - Best for: Objects with distinct colors
  #   - Speed: Fastest (~2-3ms per object)
  #   - Accuracy: Good for color-distinct objects
  #   - Recommended for: Embedded systems, colored targets
  #
  # "hog": Shape/texture-based matching (Histogram of Oriented Gradients)
  #   - Best for: Similar colors but different shapes
  #   - Speed: Moderate (~5-7ms per object)
  #   - Accuracy: Better for shape discrimination
  #   - Recommended for: Monochrome or similar-colored objects
  #
  # "hybrid": Combines histogram + HOG features
  #   - Best for: Maximum accuracy in challenging scenarios
  #   - Speed: Slower (~8-10ms per object)
  #   - Accuracy: Highest overall
  #   - Recommended for: Powerful hardware, critical applications
  APPEARANCE_FEATURE_TYPE: "histogram"

  # === Memory Window ===
  # How long to remember lost objects (in frames)
  # Object features are stored for this duration after losing track
  # Higher = can re-identify after longer occlusions (uses more memory ~1KB per object)
  # Lower = faster cleanup, less memory usage
  # Recommended values:
  #   - 30 frames: ~1 second at 30 FPS (good for brief occlusions)
  #   - 60 frames: ~2 seconds (balanced)
  #   - 150 frames: ~5 seconds (long occlusions, uses more memory)
  MAX_REIDENTIFICATION_FRAMES: 30

  # === Adaptive Learning ===
  # Update appearance model during successful tracking
  # Helps adapt to gradual changes in lighting, viewing angle, or object appearance
  # true = model adapts over time (better for changing conditions)
  # false = uses initial appearance only (more consistent but rigid)
  APPEARANCE_ADAPTIVE_LEARNING: true

  # Learning rate for adaptive updates (0.0-1.0)
  # Higher = faster adaptation to changes (may drift from original appearance)
  # Lower = slower adaptation (more stable, less responsive to changes)
  # Recommended: 0.05-0.15
  APPEARANCE_LEARNING_RATE: 0.1

  # === HOG Feature Parameters ===
  # Only used when APPEARANCE_FEATURE_TYPE = "hog" or "hybrid"
  # Histogram of Oriented Gradients configuration for shape-based matching
  HOG_WIN_SIZE: [64, 64]              # ROI resize dimensions (width, height)
  HOG_BLOCK_SIZE: [16, 16]            # Block size for normalization
  HOG_BLOCK_STRIDE: [8, 8]            # Step size for block overlap
  HOG_CELL_SIZE: [8, 8]               # Cell size within blocks
  HOG_NBINS: 9                        # Number of orientation bins (1-180 degrees)

  # === Color Histogram Parameters ===
  # Only used when APPEARANCE_FEATURE_TYPE = "histogram" or "hybrid"
  HIST_H_BINS: 30                     # Hue channel bins (H in HSV)
  HIST_S_BINS: 32                     # Saturation channel bins (S in HSV)

  # === Performance Profiling ===
  # Enable profiling to measure feature extraction and matching performance
  ENABLE_APPEARANCE_PROFILING: false  # true = log timing metrics to console


# ==============================================================================
# GIMBAL TRACKER CONFIGURATION (New Feature)
# ==============================================================================
GimbalTracker:
  # Enable/disable gimbal tracker
  ENABLED: true

  # Network configuration for gimbal UDP communication
  UDP_HOST: "192.168.144.110"    # Gimbal IP address (camera network)
  UDP_PORT: 9003                # Gimbal UDP port
  CONNECTION_TIMEOUT: 5.0       # Connection timeout in seconds

  # Data quality and recovery parameters
  data_timeout_seconds: 5.0     # Show cached data for up to N seconds when connection lost
  max_consecutive_failures: 10  # Warning threshold for consecutive data reception failures

# Global gimbal parameters (accessed by GimbalTracker and GimbalInterface)
GIMBAL_UDP_HOST: "192.168.144.110"    # Gimbal IP address (camera network)
GIMBAL_LISTEN_PORT: 9004               # Port for listening to gimbal data
GIMBAL_COORDINATE_SYSTEM: "GIMBAL_BODY"  # Coordinate system preference
GIMBAL_DISABLE_ESTIMATOR: true         # Disable Kalman estimator for gimbal

GimbalTrackerSettings:
  # Coordinate system configuration
  COORDINATE_SYSTEM: "GIMBAL_BODY"  # Options: "GIMBAL_BODY", "SPATIAL_FIXED"

  # Camera mount offsets (degrees relative to aircraft body frame)
  CAMERA_MOUNT_OFFSET_ROLL: 0.0    # Roll offset
  CAMERA_MOUNT_OFFSET_PITCH: 0.0   # Pitch offset (+ = nose down from aircraft)
  CAMERA_MOUNT_OFFSET_YAW: 0.0     # Yaw offset (+ = right from aircraft nose)

  # Validation limits
  YAW_LIMIT: 180.0              # Maximum yaw angle (degrees)
  PITCH_LIMIT: 90.0             # Maximum pitch angle (degrees)
  ROLL_LIMIT: 180.0             # Maximum roll angle (degrees)

  # Processing configuration
  SUPPRESS_DETECTOR: true       # Disable image detector (not needed for gimbal)
  SUPPRESS_PREDICTOR: true      # Disable predictor (not needed for gimbal)
  DISABLE_ESTIMATOR: true       # Disable Kalman estimator (gimbal provides direct data)

  # Data quality parameters
  MAX_DATA_AGE: 5.0            # Maximum age of data to consider valid (seconds)


# ==============================================================================
# FOLLOWER MODE (Drone Following Behavior)
# ==============================================================================
Follower:
  # === Interface Settings ===
  USE_MAVLINK2REST: true                    # Use REST API for MAVLink
  FOLLOWER_DATA_REFRESH_RATE: 5             # Hz

  # === Target Selection ===
  ROI_SELECTION_MODE: MANUAL                # MANUAL or AUTO
  TARGET_POSITION_MODE: center              # center, top, bottom

  # === Following Mode ===
  # Options: mc_velocity_ground, mc_velocity_distance, mc_velocity_position, mc_velocity_chase, mc_velocity, mc_attitude_rate, fw_attitude_rate, gm_velocity_unified, gm_velocity_vector
  # Deprecated (still work): ground_view, constant_distance, constant_position, body_velocity_chase, gimbal_vector_body
  # For gimbal testing: gm_velocity_vector (direct vector pursuit)
  FOLLOWER_MODE: gm_velocity_vector
  
  # === Visualization ===
  SHOW_TRACKING_WINDOW: false               # Debug window
  DISPLAY_DEVIATIONS: false                 # Show error vectors
  TRACKED_BBOX_STYLE: fancy                 # simple or fancy
  FOLLOWER_ACTIVE_COLOR: [0, 0, 255]       # BGR: Red when active
  FOLLOWER_INACTIVE_COLOR: [0, 255, 255]   # BGR: Yellow when inactive
  BBOX_LINE_THICKNESS: 2
  EXTENDED_LINE_THICKNESS: 2
  CORNER_DOT_RADIUS: 4
  CROSSHAIR_ARM_LENGTH: 20
  BBOX_CORNER_ARM_LENGTH: 20
  OVERLAY_OPACITY: 128

# === Circuit Breaker (Safety & Testing) ===
# SAFETY FIRST: Global circuit breaker for follower testing without drone commands
# Default: true (SAFE) - Only set to false when you explicitly want to send real commands
FOLLOWER_CIRCUIT_BREAKER: true            # true = SAFE (log only), false = LIVE (send commands)
CIRCUIT_BREAKER_DISABLE_SAFETY: false     # Skip ALL safety checks in CB test mode (set true for ground testing only)


# ==============================================================================
# GIMBAL FOLLOWER CONFIGURATION
# ==============================================================================
GimbalFollower:
  # === Mount Configuration ===
  MOUNT_TYPE: "VERTICAL"                    # Options: "HORIZONTAL", "VERTICAL"
  CONTROL_MODE: "BODY"                      # Options: "NED", "BODY"

  # === Required Tracker Fields ===
  REQUIRED_TRACKER_FIELDS: ["angular"]     # Must have angular data from gimbal

  # === Velocity Control ===
  # SLOW SPEEDS FOR TESTING - increase after validation
  BASE_VELOCITY: 0.3                       # Base following velocity (m/s) - SLOW for testing
  MAX_VELOCITY: 0.5                        # Maximum velocity limit (m/s) - SLOW for testing
  VELOCITY_RAMP_RATE: 0.2                  # Acceleration rate (m/s¬≤) - slow ramp
  VELOCITY_FILTER_ALPHA: 0.7               # Velocity smoothing filter coefficient (0-1)

  # === Forward Velocity Control System ===
  # Based on 2024 guidance control research for reliable target interception
  FORWARD_VELOCITY_MODE: "CONSTANT"        # Options: "CONSTANT", "PITCH_BASED", "PROPORTIONAL_NAV" (future)
  BASE_FORWARD_SPEED: 0.3                  # Constant forward speed (m/s) - SLOW for testing
  MAX_FORWARD_VELOCITY: 0.5                # Maximum forward velocity limit (m/s) - SLOW for testing
  FORWARD_ACCELERATION: 0.2                # Ramp rate - slow for testing

  # === Lateral Guidance Mode ===
  LATERAL_GUIDANCE_MODE: "coordinated_turn" # Options: "coordinated_turn", "sideslip"
  ENABLE_AUTO_MODE_SWITCHING: false        # Auto-switch based on forward velocity
  GUIDANCE_MODE_SWITCH_VELOCITY: 3.0       # Switch velocity threshold (m/s)

  # === Yaw Control ===
  MAX_YAW_RATE: 45.0                      # Maximum yaw rate (degrees/second)

  # === Target Loss Handling ===
  TARGET_LOSS_HANDLING:
    CONTINUE_VELOCITY_TIMEOUT: 3.0         # Continue last velocity for N seconds
    ENABLE_RTL_ON_TIMEOUT: false           # Disabled - RC pilot controls, hold position
    RTL_ALTITUDE: 50.0                     # RTL altitude (meters) - not used when disabled

    # === Enhanced Timeout Behaviors (PHASE 3.2) ===
    ENABLE_ADAPTIVE_TIMEOUT: true          # Adjust timeout based on target movement/confidence
    ADAPTIVE_TIMEOUT_FACTOR: 1.5           # Multiplier for fast-moving targets
    ENABLE_PREDICTIVE_VELOCITY: true       # Use movement prediction during loss
    PREDICTION_HISTORY_SIZE: 5             # Number of samples for prediction
    CONFIDENCE_TIMEOUT_ADJUSTMENT: true    # Adjust timeout based on tracking confidence
    HIGH_CONFIDENCE_THRESHOLD: 0.8         # High confidence threshold
    LOW_CONFIDENCE_THRESHOLD: 0.3          # Low confidence threshold

  # === Safety Parameters (Override global SafetyLimits if needed) ===
  # These use unified naming: MIN_ALTITUDE, MAX_ALTITUDE
  # If not specified, values inherit from SafetyLimits section
  # MIN_ALTITUDE: 3.0                     # Override global minimum altitude (meters)
  # MAX_ALTITUDE: 120.0                   # Override global maximum altitude (meters)
  MAX_SAFETY_VIOLATIONS: 5                # Maximum allowed safety violations before blocking
  SAFETY_RETURN_SPEED: 3.0                # Velocity when returning to safe altitude (m/s)
  EMERGENCY_STOP_ENABLED: true            # Enable emergency velocity zeroing

  # === Coordinate Transformation ===
  ANGLE_DEADZONE: 2.0                     # Ignore gimbal movements below this (degrees)
  TRANSFORMATION_VALIDATION: true         # Validate coordinate transformations

  # === Enhanced Transformation Parameters ===
  # NOTE: NEUTRAL_PITCH_ANGLE is now handled automatically based on MOUNT_TYPE
  # VERTICAL mount: neutral = 90¬∞ (level), HORIZONTAL mount: uses configured value
  NEUTRAL_PITCH_ANGLE: 0.0                # Neutral pitch for HORIZONTAL mount only (degrees)
  PITCH_VELOCITY_SCALING: 0.15            # Pitch error to velocity scaling factor
  PITCH_DEADZONE_DEGREES: 2.0             # Pitch deadzone to prevent jitter (degrees)
  MAX_ROLL_ANGLE: 90.0                    # Maximum expected roll range (degrees)
  MAX_PITCH_ANGLE: 90.0                   # Maximum expected pitch range (degrees)
  INVERT_LATERAL_CONTROL: false           # Invert lateral control for different gimbal orientations
  INVERT_VERTICAL_CONTROL: true          # Invert vertical control for different gimbal orientations

  # === Gimbal Direction Conventions ===
  # Configure these based on your specific gimbal's angle reporting convention
  ROLL_RIGHT_SIGN: "POSITIVE"             # "POSITIVE" if look_right=positive_roll, "NEGATIVE" if look_right=negative_roll

  # === Default Values for Optional Features ===
  DEFAULT_THRUST: 0.5                     # Default thrust for attitude rate control mode

  # === Performance ===
  UPDATE_RATE: 20.0                       # Control loop frequency (Hz)
  COMMAND_SMOOTHING_ENABLED: true         # Enable velocity command smoothing
  SMOOTHING_FACTOR: 0.8                   # Smoothing coefficient (0-1)

# ==============================================================================
# GIMBAL VECTOR BODY FOLLOWER CONFIGURATION
# ==============================================================================
# Direct vector pursuit using gimbal angles transformed to body-frame velocity
# No PID tuning required - deterministic geometric control
GM_VELOCITY_VECTOR:
  # === Mount Configuration ===
  # Defines how the gimbal is physically mounted relative to the drone body frame
  # VERTICAL: Camera points down when gimbal is level (neutral pitch=90¬∞)
  #           Common for inspection drones, mapping, surveillance
  # HORIZONTAL: Camera points forward when gimbal is level (neutral pitch=0¬∞)
  #             Common for racing drones, standard FPV setups
  # TILTED_45: Camera angled 45¬∞ down (FPV racing style)
  MOUNT_TYPE: "HORIZONTAL"                  # Options: "VERTICAL", "HORIZONTAL", "TILTED_45"

  # === Velocity Scaling (Linear Ramp) ===
  # Direct vector pursuit: gimbal angle ‚Üí unit vector ‚Üí scaled velocity
  # VERY SLOW FOR TESTING - increase after validation
  MIN_VELOCITY: 0.0                      # m/s - minimum pursuit speed (prevents stalling)
  MAX_VELOCITY: 0.3                       # m/s - SLOW for testing (increase for production)
  RAMP_ACCELERATION: 0.15                 # m/s¬≤ - slow acceleration for testing
  INITIAL_VELOCITY: 0.0                   # m/s - starting velocity (0 = smooth start)

  # === Control Enablement ===
  # Altitude control uses gimbal pitch to compute vertical velocity
  # When disabled, only horizontal pursuit (vel_down = 0, safer default)
  ENABLE_ALTITUDE_CONTROL: true           # ENABLED for 3D vector pursuit testing
  ENABLE_YAW_CONTROL: false               # Optional: yaw drone toward target
  YAW_RATE_GAIN: 0.5                      # Yaw rate proportional gain (if enabled)

  # === Gimbal Angle Filtering ===
  # Real-world gimbals have jitter and noise - filtering provides smooth control
  ANGLE_DEADZONE_DEG: 2.0                 # Ignore gimbal movements below this threshold (degrees)
  ANGLE_SMOOTHING_ALPHA: 0.7              # EMA filter coefficient (0-1, higher = smoother)
                                          # Recommended: 0.6-0.8 for typical gimbals

  # === Altitude Safety (Optional Enforcement) ===
  # Enable altitude monitoring and enforcement (similar to BODY_VELOCITY_CHASE)
  # Uses unified naming: MIN_ALTITUDE, MAX_ALTITUDE (overrides global SafetyLimits if set)
  ALTITUDE_SAFETY_ENABLED: false          # Disabled - RC pilot is in control
  MIN_ALTITUDE: 5.0                       # Override global minimum altitude (meters)
  MAX_ALTITUDE: 50.0                      # Override global maximum altitude (meters)
  ALTITUDE_CHECK_INTERVAL: 0.5            # seconds - altitude check frequency
  RTL_ON_ALTITUDE_VIOLATION: false        # Disabled - hold position, RC pilot controls

  # === General Safety Parameters ===
  EMERGENCY_STOP_ENABLED: true            # Enable emergency velocity zeroing
  MAX_SAFETY_VIOLATIONS: 5                # Max consecutive safety violations before halt

  # === Target Loss Handling ===
  # When gimbal tracking is lost, coast on last velocity vector with decay
  TARGET_LOSS_TIMEOUT: 3.0                # seconds - coast duration before stopping
  ENABLE_VELOCITY_DECAY: true             # Gradually reduce velocity during loss
  VELOCITY_DECAY_RATE: 0.5                # m/s¬≤ - deceleration rate during target loss

  # === Performance ===
  UPDATE_RATE: 20.0                       # Hz - control loop frequency
  COMMAND_SMOOTHING_ENABLED: true         # Smooth velocity command transitions
  SMOOTHING_FACTOR: 0.8                   # Smoothing coefficient (0-1)

  # === Advanced: Mount Calibration Overrides (Expert Users Only) ===
  # Leave at 0.0 to use preset transformations from MOUNT_TYPE
  # Only adjust if gimbal is mounted at non-standard angles
  MOUNT_ROLL_OFFSET_DEG: 0.0              # Manual roll offset (degrees)
  MOUNT_PITCH_OFFSET_DEG: 0.0             # Manual pitch offset (degrees)
  MOUNT_YAW_OFFSET_DEG: 0.0               # Manual yaw offset (degrees)

  # === Advanced: Gimbal Direction Inversions ===
  # Use if gimbal reports angles with opposite sign convention
  INVERT_GIMBAL_ROLL: false               # Invert roll axis
  INVERT_GIMBAL_PITCH: false              # Invert pitch axis
  INVERT_GIMBAL_YAW: false                # Invert yaw axis

MC_VELOCITY_CHASE:
  # === Forward Velocity Ramping ===
  # SLOW SPEEDS FOR TESTING - ready for USB camera testing
  INITIAL_FORWARD_VELOCITY: 0.0           # m/s - starting velocity
  MAX_FORWARD_VELOCITY: 0.5               # m/s - SLOW for testing (increase after validation)
  FORWARD_RAMP_RATE: 0.25                 # m/s¬≤ - slow acceleration for testing
  RAMP_DOWN_ON_TARGET_LOSS: true          # Decelerate when target lost
  TARGET_LOSS_TIMEOUT: 2.0                # seconds before ramp down starts
  # Target loss stop velocity: ramp to this when target lost (0.0 = full stop)
  TARGET_LOSS_STOP_VELOCITY: 0.0          # m/s - velocity on target loss (0.0 = stop)
  # Coordinate threshold for detecting lost target (values > this indicate lost)
  TARGET_LOSS_COORDINATE_THRESHOLD: 990   # Configurable threshold for lost target detection

  # === Control Enablement ===
  #
  # ‚ö†Ô∏è ALTITUDE CONTROL BEHAVIOR:
  # - ENABLE_ALTITUDE_CONTROL: Controls whether follower CALCULATES altitude commands
  #   * true: Actively tracks target in 3D space (follows target up/down)
  #   * false: Altitude commands remain 0, drone maintains current altitude
  #
  # For SITL/Flight Testing:
  #   Set ENABLE_ALTITUDE_CONTROL: true (to chase target in 3D)
  #
  # For Ground Testing:
  #   ENABLE_ALTITUDE_CONTROL: false (keeps altitude at 0 - safe for ground)
  #
  ENABLE_ALTITUDE_CONTROL: true            # ENABLED for flight testing

  # === LATERAL GUIDANCE MODES ===
  # Two guidance strategies for lateral target tracking:
  # - sideslip: Direct lateral velocity (v_right ‚â† 0, yaw_rate = 0)
  #   Best for: Precision hovering, close proximity, confined spaces
  # - coordinated_turn: Turn-to-track (v_right = 0, yaw_rate ‚â† 0) 
  #   Best for: Forward flight efficiency, natural behavior, wind resistance
  LATERAL_GUIDANCE_MODE: coordinated_turn     # sideslip | coordinated_turn
  GUIDANCE_MODE_SWITCH_VELOCITY: 3.0          # m/s - auto-switch threshold
  ENABLE_AUTO_MODE_SWITCHING: false          # Auto-switch based on forward velocity
  
  # === üõ°Ô∏è ALTITUDE SAFETY (Overrides global SafetyLimits) ===
  #
  # ‚ö†Ô∏è IMPORTANT - Two Different Altitude Flags:
  #
  # 1. ENABLE_ALTITUDE_CONTROL (above) - Controls altitude COMMAND generation
  #    - false: Follower never sends altitude commands (vel_down = 0 always)
  #    - true: Follower calculates and sends altitude commands
  #
  # 2. ALTITUDE_SAFETY_ENABLED (below) - Controls altitude LIMIT enforcement
  #    - false: No altitude boundary checks (useful for ground testing)
  #    - true: Enforces MIN_ALTITUDE/MAX_ALTITUDE bounds, triggers RTL on violation
  #
  # Typical Configurations:
  # - Ground Testing: ENABLE_ALTITUDE_CONTROL=false, ALTITUDE_SAFETY_ENABLED=false
  # - SITL Testing: ENABLE_ALTITUDE_CONTROL=true, ALTITUDE_SAFETY_ENABLED=true
  # - Flight Testing: ENABLE_ALTITUDE_CONTROL=true, ALTITUDE_SAFETY_ENABLED=true
  #
  # Uses unified naming: MIN_ALTITUDE, MAX_ALTITUDE
  ALTITUDE_SAFETY_ENABLED: false          # Disabled - RC pilot is in control
  MIN_ALTITUDE: 5.0                       # Override: stricter minimum altitude (meters)
  MAX_ALTITUDE: 50.0                      # Override: stricter maximum altitude (meters)
  ALTITUDE_CHECK_INTERVAL: 0.1            # seconds - 100ms check frequency (fast safety checks)
  RTL_ON_ALTITUDE_VIOLATION: false        # Disabled - hold position, RC pilot controls

  # === Safety Limits (Additional to Schema Limits) ===
  EMERGENCY_STOP_ENABLED: true            # ENABLED for flight testing
  MAX_TRACKING_ERROR: 1.5                 # Max normalized error before limiting
  VELOCITY_SMOOTHING_ENABLED: true       # Enable velocity command smoothing
  SMOOTHING_FACTOR: 0.8                  # Smoothing coefficient (0-1)
  
  # === Performance Tuning ===
  MIN_FORWARD_VELOCITY_THRESHOLD: 0.2    # m/s - minimum velocity to maintain (important if using a fixedwing or VTOL)
  RAMP_UPDATE_RATE: 10.0                 # Hz - forward velocity update frequency
  PID_UPDATE_RATE: 20.0                  # Hz - tracking PID update frequency

  # === üéØ ADAPTIVE DIVE/CLIMB CONTROL (Advanced Feature) ===
  # Vertical-rate-based dive/climb angle adaptation for optimal target intercept
  # Addresses early descent (far target) and late descent (close target) scenarios
  # Uses visual feedback to adaptively adjust v_fwd and v_down balance
  #
  # When to Enable:
  # - Target distance varies significantly (near/far scenarios)
  # - Prefer slant approach trajectories vs early descent
  # - Have high-confidence, stable tracking (confidence > 0.6)
  #
  # When to Disable:
  # - Noisy visual tracking (causes oscillations)
  # - Low framerate (<15 FPS) - rate estimation unreliable
  # - Simple scenarios with consistent target distance
  #
  ENABLE_ADAPTIVE_DIVE_CLIMB: false      # Master enable/disable (off by default for stability)

  # === Rate Estimation & Filtering ===
  ADAPTIVE_SMOOTHING_ALPHA: 0.2          # EMA smoothing factor (0.1-0.5)
                                         # Lower = more filtering (stable, slower response)
                                         # Higher = less filtering (responsive, noisier)
                                         # Recommended: 0.15-0.25 for 20-30 FPS tracking

  ADAPTIVE_WARMUP_FRAMES: 10             # Frames to ignore on startup (5-15)
                                         # Allows rate estimator to stabilize
                                         # Higher = safer startup, slower activation

  ADAPTIVE_RATE_THRESHOLD: 5.0           # Pixels/sec error threshold to trigger correction
                                         # Dead-zone to prevent over-reaction to noise
                                         # Adjust based on image resolution and framerate
                                         # Recommended: 3-8 px/s for 640x480 @ 30fps

  # === Correction Authority ===
  ADAPTIVE_MAX_CORRECTION: 1.0           # Maximum velocity correction (m/s)
                                         # Limits how much adaptive mode can change v_down/v_fwd
                                         # Lower = gentler adjustments, higher = more aggressive
                                         # Recommended: 0.5-1.5 m/s

  ADAPTIVE_CORRECTION_GAIN: 0.3          # Proportional gain on rate error (0.1-0.8)
                                         # Lower = gentle corrections, higher = aggressive
                                         # Start conservative (0.2-0.3), increase if response too slow

  ADAPTIVE_MIN_CONFIDENCE: 0.6           # Minimum tracker confidence to activate (0.0-1.0)
                                         # Higher = only activates with high-quality tracking
                                         # Recommended: 0.5-0.7

  # === Forward Velocity Coupling (Advanced) ===
  ADAPTIVE_FWD_COUPLING_ENABLED: false   # Allow v_fwd adjustments (in addition to v_down)
                                         # true = Adjust both v_fwd and v_down for faster response
                                         # false = Only adjust v_down (safer, simpler)
                                         # Recommend: false initially, enable after tuning

  ADAPTIVE_FWD_COUPLING_GAIN: 0.1        # v_fwd adjustment gain (0.05-0.2)
                                         # Only used if ADAPTIVE_FWD_COUPLING_ENABLED = true
                                         # Lower values recommended to maintain chase velocity

  # === Calibration ===
  PIXEL_TO_RATE_CALIBRATION: 0.05        # Calibration factor: meters/sec per pixels/sec
                                         # Platform-specific, requires field tuning
                                         # Depends on: camera FOV, altitude, image resolution
                                         # Start with 0.03-0.08, adjust based on observed behavior
                                         # Higher = more aggressive response to visual rate changes

  # === Safety & Monitoring ===
  ADAPTIVE_OSCILLATION_DETECTION: true   # Enable oscillation detection (recommended)
  ADAPTIVE_MAX_SIGN_CHANGES: 3           # Max sign changes in 2 seconds before disable
  ADAPTIVE_DIVERGENCE_TIMEOUT: 5.0       # Seconds - disable if error grows despite corrections

  # === üéØ PITCH ANGLE COMPENSATION (Advanced Feature) ===
  # Compensates for camera pitch-induced vertical image shifts during forward flight
  # See config.yaml for comprehensive documentation and calibration guide
  ENABLE_PITCH_COMPENSATION: false       # Master enable/disable (off by default for safety)
  PITCH_COMPENSATION_MODEL: "linear_velocity"  # linear_velocity | linear_angle | quadratic
  PITCH_COMPENSATION_GAIN: 0.05          # Calibration factor (0.01-0.15 typical)
  PITCH_DATA_SMOOTHING_ALPHA: 0.7        # EMA filter (0.6-0.8 recommended)
  PITCH_DATA_MAX_AGE: 0.5                # Max data age in seconds
  PITCH_COMPENSATION_MIN_VELOCITY: 1.0   # Min v_fwd to activate (m/s)
  PITCH_COMPENSATION_DEADBAND: 2.0       # Ignore pitch below this (degrees)
  PITCH_COMPENSATION_MAX_ANGLE: 45.0     # Safety limit (degrees)
  PITCH_COMPENSATION_MAX_CORRECTION: 0.3 # Max compensation magnitude (0.0-1.0)
  PITCH_COMPENSATION_ADAPTIVE_GAIN: false # Future: adaptive gain tuning

# ==============================================================================
# CONSTANT POSITION FOLLOWER CONFIGURATION
# ==============================================================================
MC_VELOCITY_POSITION:
  # === Control Enablement ===
  #
  # ‚ö†Ô∏è ALTITUDE CONTROL BEHAVIOR:
  # - ENABLE_ALTITUDE_CONTROL: Controls whether follower CALCULATES altitude commands
  #   * true: Actively maintains target altitude during tracking (tracks initial Z position)
  #   * false: Altitude commands remain 0, drone maintains current altitude
  #
  # For SITL/Flight Testing:
  #   Set ENABLE_ALTITUDE_CONTROL: true (to actively follow target altitude)
  #
  # For Ground Testing:
  #   ENABLE_ALTITUDE_CONTROL: false (keeps altitude at 0 - safe for ground)
  #
  ENABLE_ALTITUDE_CONTROL: false           # Disabled by default for ground testing
  ENABLE_YAW_CONTROL: true                # Always enabled for this mode

  # === Altitude Parameters (Uses unified naming, inherits from SafetyLimits) ===
  # MIN_ALTITUDE: 3.0                     # Override global minimum altitude (meters)
  # MAX_ALTITUDE: 120.0                   # Override global maximum altitude (meters)
  MAX_VERTICAL_VELOCITY: 3.0              # Max vertical velocity (m/s)

  # === Yaw Control ===
  MAX_YAW_RATE: 10.0                      # Max yaw rate (deg/s)
  YAW_CONTROL_THRESHOLD: 0.02             # Dead zone threshold (normalized)

  # === Safety & Performance ===
  TARGET_LOST_TIMEOUT: 3.0                # Target loss timeout (seconds)
  CONTROL_UPDATE_RATE: 20.0               # Control loop frequency (Hz)
  COMMAND_SMOOTHING_ENABLED: true         # Enable velocity smoothing
  SMOOTHING_FACTOR: 0.8                   # Smoothing coefficient (0-1)

# ==============================================================================
# CONSTANT DISTANCE FOLLOWER CONFIGURATION
# ==============================================================================
MC_VELOCITY_DISTANCE:
  # === Control Enablement ===
  #
  # ‚ö†Ô∏è ALTITUDE CONTROL BEHAVIOR:
  # - ENABLE_ALTITUDE_CONTROL: Controls whether follower CALCULATES altitude commands
  #   * true: Actively maintains constant vertical distance from target
  #   * false: Altitude commands remain 0, drone maintains current altitude
  #
  # For SITL/Flight Testing:
  #   Set ENABLE_ALTITUDE_CONTROL: true (to maintain vertical distance)
  #
  # For Ground Testing:
  #   ENABLE_ALTITUDE_CONTROL: false (keeps altitude at 0 - safe for ground)
  #
  ENABLE_YAW_CONTROL: false              # Enable yaw rate control for target centering
  ENABLE_ALTITUDE_CONTROL: false          # Disabled by default for ground testing

  # === Altitude Parameters (Uses unified naming, inherits from SafetyLimits) ===
  # MIN_ALTITUDE: 3.0                    # Override global minimum altitude (meters)
  # MAX_ALTITUDE: 120.0                  # Override global maximum altitude (meters)
  MAX_VERTICAL_VELOCITY: 5.0             # Max vertical velocity (m/s)

  # === Lateral Control ===
  MAX_LATERAL_VELOCITY: 10.0             # Max lateral velocity (m/s)

  # === Yaw Control ===
  MAX_YAW_RATE: 10.0                     # Max yaw rate (deg/s)
  YAW_CONTROL_THRESHOLD: 0.3             # Dead zone threshold (normalized)

  # === Safety & Performance ===
  TARGET_LOST_TIMEOUT: 3.0               # Target loss timeout (seconds)
  CONTROL_UPDATE_RATE: 20.0              # Control loop frequency (Hz)
  COMMAND_SMOOTHING_ENABLED: true        # Enable velocity smoothing
  SMOOTHING_FACTOR: 0.8                  # Smoothing coefficient (0-1)

  # === Distance Maintenance ===
  DISTANCE_HOLD_ENABLED: true            # Maintain constant forward distance
  DISTANCE_HOLD_TOLERANCE: 0.1           # Distance tolerance (normalized)

# ==============================================================================
# FIXED-WING FOLLOWER CONFIGURATION
# ==============================================================================
# Professional fixed-wing target following with L1 navigation and TECS energy management
# Uses attitude rate commands (the ONLY offboard mode supported by PX4 for fixed-wing)
#
# Control Architecture:
# - L1 Navigation: Lateral guidance (cross-track error ‚Üí yaw rate)
# - TECS: Longitudinal control (altitude/speed errors ‚Üí pitch rate, throttle)
# - Coordinated Turn: Bank angle calculation from yaw rate
#
# CRITICAL: PX4 fixed-wing IGNORES velocity body commands in offboard mode!
# This follower MUST use attitude_rate control type.
# ==============================================================================
FW_ATTITUDE_RATE:
  # === FLIGHT ENVELOPE ===
  MIN_AIRSPEED: 12.0              # m/s - stall speed + safety margin
  CRUISE_AIRSPEED: 18.0           # m/s - optimal efficiency airspeed
  MAX_AIRSPEED: 30.0              # m/s - structural/performance limit
  STALL_MARGIN_BUFFER: 3.0        # m/s - safety buffer above stall speed

  # === STRUCTURAL LIMITS ===
  MAX_BANK_ANGLE: 35.0            # degrees - coordinated turn limit
  MAX_LOAD_FACTOR: 2.5            # g - structural load factor limit
  MAX_PITCH_ANGLE: 25.0           # degrees - pitch up limit
  MIN_PITCH_ANGLE: -20.0          # degrees - pitch down limit

  # === RATE LIMITS (deg/s) ===
  MAX_ROLL_RATE: 45.0             # deg/s - roll rate limit
  MAX_PITCH_RATE: 20.0            # deg/s - pitch rate limit
  MAX_YAW_RATE: 25.0              # deg/s - yaw rate limit (turn rate)

  # === L1 NAVIGATION (Lateral Guidance) ===
  # L1 provides smooth, stable lateral guidance using a lookahead distance
  # Larger L1 = smoother but slower response; Smaller L1 = faster but more aggressive
  L1_DISTANCE: 50.0               # m - lookahead distance
  L1_DAMPING: 0.75                # damping ratio (0.7-1.0 recommended)
  ENABLE_L1_ADAPTIVE: false       # Adapt L1 distance to current airspeed
  L1_MIN_DISTANCE: 20.0           # m - minimum L1 for low speed
  L1_MAX_DISTANCE: 100.0          # m - maximum L1 for high speed

  # === TECS (Total Energy Control System - Longitudinal Control) ===
  # TECS coordinates pitch and throttle for optimal energy management:
  # - Throttle controls TOTAL energy (altitude + speed)
  # - Pitch controls ENERGY BALANCE (trade altitude for speed or vice versa)
  ENABLE_TECS: true               # Use TECS energy management (recommended)
  TECS_TIME_CONST: 5.0            # seconds - energy response time constant
  TECS_PITCH_DAMPING: 1.0         # pitch axis damping factor
  TECS_THROTTLE_DAMPING: 0.5      # throttle axis damping factor
  TECS_SPE_WEIGHT: 1.0            # altitude vs speed priority (>1 = altitude priority)

  # === THRUST CONTROL ===
  MIN_THRUST: 0.2                 # minimum throttle (idle - never below for fixed-wing!)
  MAX_THRUST: 1.0                 # maximum throttle
  CRUISE_THRUST: 0.6              # typical cruise throttle
  THRUST_SLEW_RATE: 0.5           # max throttle change per second (smooth transitions)

  # === COORDINATED TURN ===
  # Ensures proper bank angle for zero-sideslip turns
  ENABLE_COORDINATED_TURN: true   # Calculate bank from yaw rate (recommended)
  TURN_COORDINATION_GAIN: 1.0     # Fine-tune turn coordination (1.0 = standard)
  SLIP_ANGLE_LIMIT: 5.0           # degrees - max sideslip allowed

  # === ALTITUDE SAFETY ===
  ENABLE_ALTITUDE_SAFETY: true    # Monitor altitude bounds
  MIN_ALTITUDE: 30.0              # m AGL - terrain clearance
  MAX_ALTITUDE: 400.0             # m AGL - airspace limit
  ALTITUDE_CHECK_INTERVAL: 0.1    # seconds between checks
  RTL_ON_ALTITUDE_VIOLATION: true # Trigger RTL on altitude violation

  # === STALL PROTECTION ===
  # Critical for fixed-wing safety - monitors airspeed and initiates recovery
  ENABLE_STALL_PROTECTION: true   # Monitor airspeed for stall conditions
  STALL_RECOVERY_PITCH: -5.0      # degrees - nose down for recovery
  STALL_RECOVERY_THROTTLE: 1.0    # full throttle for energy recovery

  # === TARGET LOSS HANDLING ===
  # Fixed-wing cannot hover - must orbit or RTL when target is lost
  TARGET_LOSS_TIMEOUT: 3.0        # seconds before taking action
  TARGET_LOSS_ACTION: orbit       # Options: orbit, rtl, continue_last
  ORBIT_RADIUS: 100.0             # m - loiter radius on target loss
  TARGET_LOSS_COORDINATE_THRESHOLD: 990  # Threshold for lost target detection

  # === PERFORMANCE TUNING ===
  CONTROL_UPDATE_RATE: 20.0       # Hz - control loop frequency
  ENABLE_COMMAND_SMOOTHING: true  # Apply EMA smoothing to commands
  SMOOTHING_FACTOR: 0.85          # EMA coefficient (0-1, higher = more smooth)

# ==============================================================================
# MULTICOPTER FOLLOWER CONFIGURATION
# ==============================================================================
# Professional multicopter target following with dual-mode lateral guidance.
# Supports: YAW_TO_TARGET (fixed-wing style) and CRAB_STRAFE (strafing)
# Control type: velocity_body_offboard (most stable for multicopters)
#
# Key Advantages over Fixed-Wing:
# - Can HOVER on target loss (instead of orbit)
# - Can strafe laterally (CRAB_STRAFE mode)
# - Zero forward velocity is acceptable
# - Uses stable velocity_body_offboard control
# ==============================================================================
MC_VELOCITY:
  # === LATERAL GUIDANCE MODE ===
  # yaw_to_target: Rotate to face target, fly forward (like fixed-wing)
  # crab_strafe: Maintain heading, strafe laterally (multicopter advantage)
  LATERAL_GUIDANCE_MODE: yaw_to_target       # yaw_to_target | crab_strafe
  ENABLE_AUTO_MODE_SWITCHING: false          # Auto-switch based on LOS rate/distance
  AUTO_SWITCH_DISTANCE_THRESHOLD: 20.0       # meters - close = crab_strafe

  # === FORWARD VELOCITY MODE ===
  # constant: Simple ramp to maximum velocity
  # pn: Proportional Navigation - velocity scales with LOS rate (military standard)
  # los: Line-of-Sight - velocity proportional to target offset
  FORWARD_VELOCITY_MODE: constant            # constant | pn | los

  # === FORWARD VELOCITY PARAMETERS ===
  INITIAL_FORWARD_VELOCITY: 0.0              # m/s - starting velocity
  MAX_FORWARD_VELOCITY: 2.0                  # m/s - maximum chase speed (conservative default)
  FORWARD_RAMP_RATE: 0.5                     # m/s^2 - acceleration rate (smooth 4s ramp)

  # === PROPORTIONAL NAVIGATION PARAMETERS ===
  # PN Law: V = V_base * (1 + N * |LOS_rate|)
  PN_NAVIGATION_CONSTANT: 4.0                # N (3-5 typical for intercept)
  PN_BASE_VELOCITY: 2.0                      # m/s - base velocity for PN mode (conservative)
  PN_LOS_SMOOTHING_ALPHA: 0.3                # EMA filter for LOS rate
  PN_MAX_VELOCITY_SCALE: 2.0                 # Maximum velocity multiplier

  # === LINE-OF-SIGHT PARAMETERS ===
  LOS_DISTANCE_GAIN: 0.5                     # Velocity gain for distance
  LOS_MAX_VELOCITY: 2.0                      # m/s - max LOS velocity (conservative default)

  # === TARGET LOSS HANDLING (MULTICOPTER: HOVER) ===
  # Unlike fixed-wing (orbit), multicopters can HOVER in place
  TARGET_LOSS_TIMEOUT: 2.0                   # seconds - before executing action
  TARGET_LOSS_ACTION: hover                  # hover | rtl | slow_forward
  TARGET_LOSS_COORDINATE_THRESHOLD: 990      # Threshold for lost target detection
  RAMP_DOWN_ON_TARGET_LOSS: true             # Decelerate on target loss
  SLOW_FORWARD_VELOCITY: 1.0                 # m/s - velocity for slow_forward action

  # === ALTITUDE SAFETY (Overrides global SafetyLimits) ===
  ENABLE_ALTITUDE_SAFETY: true               # Enable altitude monitoring
  MIN_ALTITUDE: 5.0                          # meters - minimum safe altitude
  MAX_ALTITUDE: 100.0                        # meters - maximum altitude
  ALTITUDE_CHECK_INTERVAL: 0.1               # seconds - 100ms safety checks
  RTL_ON_ALTITUDE_VIOLATION: true            # Trigger RTL on violation

  # === VELOCITY SATURATION PROTECTION ===
  # Prevents motor saturation by limiting total velocity magnitude
  ENABLE_VELOCITY_MAGNITUDE_LIMIT: true      # Enable magnitude limiting
  MAX_VELOCITY_MAGNITUDE: 3.0                # m/s - total vector magnitude limit (conservative)

  # === COMMAND SMOOTHING ===
  VELOCITY_SMOOTHING_ENABLED: true           # Enable velocity command smoothing
  SMOOTHING_FACTOR: 0.8                      # EMA coefficient (0-1)

  # === SAFETY ===
  EMERGENCY_STOP_ENABLED: true               # Enable emergency velocity zeroing
  MAX_TRACKING_ERROR: 1.5                    # Max normalized error before limiting

  # === CONTROL CONFIGURATION ===
  ENABLE_ALTITUDE_CONTROL: true              # Enable vertical velocity control
  CONTROL_UPDATE_RATE: 20.0                  # Hz - control loop frequency

# ==============================================================================
# MULTICOPTER ATTITUDE RATE FOLLOWER CONFIGURATION
# ==============================================================================
# Professional multicopter target follower using pure attitude rate control.
# Unlike velocity-based control, this provides direct attitude rate commands
# (roll rate, pitch rate, yaw rate, thrust) for aggressive, responsive tracking.
#
# Key Characteristics:
# - Uses set_attitude_rate() offboard command (rollspeed, pitchspeed, yawspeed, thrust)
# - Requires explicit thrust management (no automatic altitude hold)
# - Faster response than velocity cascade (direct rate control)
# - GPS-independent operation possible
# - Compatible with PNG/IBVS guidance laws
# - Target loss action: HOVER (rates=0, hover thrust)
#
# When to Use:
# - Aggressive target interception
# - GPS-denied environments
# - High-bandwidth tracking maneuvers
# - Vision-based servoing (IBVS)
# ==============================================================================
MC_ATTITUDE_RATE:
  # === GUIDANCE MODE ===
  # direct_rate: PID-based error ‚Üí rate commands (stable, predictable)
  # png: Proportional Navigation Guidance - military standard intercept law
  GUIDANCE_MODE: direct_rate                 # direct_rate | png

  # === RATE LIMITS (deg/s) ===
  # Maximum angular rates for safety and stability
  MAX_PITCH_RATE: 45.0                       # deg/s - pitch rate limit
  MAX_ROLL_RATE: 45.0                        # deg/s - roll rate limit
  MAX_YAW_RATE: 60.0                         # deg/s - yaw rate limit

  # === ANGLE LIMITS (safety) ===
  # Prevents excessive attitude angles that could cause instability
  MAX_PITCH_ANGLE: 35.0                      # degrees - max pitch (nose down)
  MAX_ROLL_ANGLE: 35.0                       # degrees - max roll (bank)
  MAX_BANK_ANGLE: 30.0                       # degrees - max bank for coordinated turns

  # === THRUST MANAGEMENT ===
  # Critical: attitude_rate control requires explicit thrust management
  # Unlike velocity control, there is NO automatic altitude hold
  HOVER_THRUST: 0.5                          # Baseline hover thrust (0.0-1.0)
  MIN_THRUST: 0.1                            # Minimum thrust (safety floor)
  MAX_THRUST: 0.9                            # Maximum thrust (motor protection)
  ENABLE_PITCH_THRUST_COMPENSATION: true     # Compensate for thrust loss at pitch angles
  PITCH_COMPENSATION_GAIN: 0.5               # Compensation aggressiveness (0.0-1.0)

  # === ALTITUDE CONTROL ===
  # Explicit altitude hold using thrust PID
  ENABLE_ALTITUDE_HOLD: true                 # Enable altitude PID for hover
  TARGET_ALTITUDE: 15.0                      # meters - default target altitude
  ALTITUDE_TOLERANCE: 1.0                    # meters - acceptable altitude error

  # === PROPORTIONAL NAVIGATION PARAMETERS ===
  # PNG Law: a_cmd = N * V_c * LOS_rate
  # Used when GUIDANCE_MODE: png
  PN_NAVIGATION_CONSTANT: 4.0                # N (3-5 typical for intercept)
  PN_LOS_SMOOTHING_ALPHA: 0.3                # EMA filter for LOS rate noise
  PN_CLOSING_VELOCITY: 5.0                   # m/s - assumed closing velocity
  PN_MIN_ACCELERATION: 0.5                   # m/s¬≤ - minimum command
  PN_MAX_ACCELERATION: 15.0                  # m/s¬≤ - maximum command

  # === YAW ERROR GATING ===
  # Safety: Don't pitch down until yaw is aligned with target
  # Prevents diving when target is to the side
  ENABLE_YAW_ERROR_GATING: true              # Enable yaw alignment check
  YAW_ERROR_THRESHOLD: 0.3                   # Normalized error threshold (0.0-1.0)
  YAW_GATING_PITCH_SCALE: 0.3                # Pitch scaling when yaw misaligned

  # === COORDINATED TURNS ===
  # Generate roll rate from yaw rate for smooth turns
  ENABLE_COORDINATED_TURNS: true             # Enable roll-yaw coordination
  TURN_COORDINATION_GAIN: 1.0                # Coordination aggressiveness

  # === TARGET LOSS HANDLING ===
  # Key advantage: multicopters can HOVER (unlike fixed-wing orbit)
  TARGET_LOSS_TIMEOUT: 2.0                   # seconds - before executing action
  TARGET_LOSS_ACTION: hover                  # hover | rtl
  TARGET_LOSS_COORDINATE_THRESHOLD: 990      # Lost target detection threshold
  RAMP_DOWN_ON_TARGET_LOSS: true             # Gradually reduce rates on loss

  # === ALTITUDE SAFETY ===
  ENABLE_ALTITUDE_SAFETY: true               # Enable altitude monitoring
  MIN_ALTITUDE: 5.0                          # meters - minimum safe altitude
  MAX_ALTITUDE: 100.0                        # meters - maximum altitude
  RTL_ON_ALTITUDE_VIOLATION: true            # Trigger RTL on violation

  # === COMMAND SMOOTHING ===
  RATE_SMOOTHING_ENABLED: true               # Enable rate command smoothing
  SMOOTHING_FACTOR: 0.85                     # EMA coefficient (0-1, higher=smoother)

  # === SAFETY ===
  EMERGENCY_STOP_ENABLED: true               # Enable emergency rate zeroing
  MAX_TRACKING_ERROR: 1.5                    # Max normalized error before limiting

  # === CONTROL CONFIGURATION ===
  CONTROL_UPDATE_RATE: 50.0                  # Hz - higher for attitude rate control

# ==============================================================================
# GROUND VIEW FOLLOWER CONFIGURATION
# ==============================================================================
MC_VELOCITY_GROUND:
  # === Target Position Mode ===
  TARGET_POSITION_MODE: center          # Target positioning: "center", "initial"

  # === Velocity Limits (Conservative defaults) ===
  MAX_VELOCITY_X: 2.0                   # Max lateral velocity (m/s) - conservative
  MAX_VELOCITY_Y: 2.0                   # Max longitudinal velocity (m/s) - conservative
  MAX_RATE_OF_DESCENT: 1.0              # Max descent rate (m/s) - conservative

  # === Descent Control (Overrides global SafetyLimits) ===
  # Uses unified naming: MIN_ALTITUDE
  ENABLE_DESCEND_TO_TARGET: false       # Enable automatic descent to target
  MIN_ALTITUDE: 40.0                    # Override: higher minimum for ground view mode (meters)

  # === Gimbal Corrections ===
  IS_CAMERA_GIMBALED: false             # Camera stabilization status
  BASE_ADJUSTMENT_FACTOR_X: 0.1         # Base correction factor for roll (X-axis)
  BASE_ADJUSTMENT_FACTOR_Y: 0.1         # Base correction factor for pitch (Y-axis)

  # === Altitude Adjustments ===
  ALTITUDE_FACTOR: 0.005                # Altitude scaling factor for distance compensation

  # === Gain Scheduling ===
  ENABLE_GAIN_SCHEDULING: false         # Enable adaptive gain scheduling
  GAIN_SCHEDULING_PARAMETER: current_altitude  # Parameter for gain scheduling

  # === Performance Tuning ===
  CONTROL_UPDATE_RATE: 20.0             # Control loop frequency (Hz)
  COORDINATE_CORRECTIONS_ENABLED: true  # Enable gimbal and altitude corrections
  ERROR_LOGGING_ENABLED: true           # Enable detailed error logging

# ==============================================================================
# DETECTOR CONFIGURATION
# ==============================================================================
Detector:
  # üîç Object detection for tracker initialization/recovery
  USE_DETECTOR: true
  DETECTION_ALGORITHM: TemplateMatching     # or FeatureMatching, YOLO
  
  # ==============================================================================
  # üîç TEMPLATE MATCHING (Re-detection for all trackers)
  # ==============================================================================
  # Used when tracker loses target - attempts to re-detect using template matching
  # Multi-scale search allows finding target at different sizes (zoom in/out)
  # ==============================================================================
  TEMPLATE_MATCHING_METHOD: TM_CCOEFF_NORMED
  TEMPLATE_UPDATE_INTERVAL: 10              # Frames between template updates
  TEMPLATE_APPEARANCE_LEARNING_RATE: 0.002  # Template adaptation speed

  # Multi-scale search (0.5x to 2x target size for drone scenarios)
  TEMPLATE_MATCHING_SCALES: [0.5, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.5, 2.0]
  TEMPLATE_MATCHING_THRESHOLD: 0.7          # Match confidence threshold

  APPEARANCE_CONFIDENCE_THRESHOLD: 0.7      # Re-detection validation
  TRACKER_CONFIDENCE_THRESHOLD_FOR_TEMPLATE_UPDATE: 0.8
  
  # === Feature Matching ===
  DEFAULT_FEATURE_EXTRACTION_ALGORITHM: ORB  # or SIFT, SURF
  ORB_NFEATURES: 500
  ORB_MIN_MATCH_COUNT: 30
  RANSAC_REPROJECTION_THRESHOLD: 10.0
  
  # === Re-detection Parameters ===
  AUTO_REDETECT: true
  REDETECTION_SEARCH_RADIUS: 300            # Pixels
  MIN_SEARCH_RADIUS: 50
  UNCERTAINTY_SCALE_FACTOR: 2.0
  ESTIMATOR_UNCERTAINTY_THRESHOLD: 1000.0

# ==============================================================================
# GSTREAMER PIPELINE TEMPLATES
# ==============================================================================
# üîß Advanced users can edit these templates
# Variables: {width}, {height}, {fps}, {device_id}, {url}, {latency}
GStreamerPipelines:
  # USB camera pipelines
  USB_YUYV: "v4l2src device=/dev/video{device_id} ! video/x-raw,format=YUY2,width={width},height={height},framerate={fps}/1 ! videoconvert ! video/x-raw,format=BGR ! appsink drop=true max-buffers=1 sync=false"
  
  USB_MJPEG: "v4l2src device=/dev/video{device_id} ! image/jpeg,width={width},height={height},framerate={fps}/1 ! jpegdec ! videoconvert ! video/x-raw,format=BGR ! appsink drop=true max-buffers=1 sync=false"
  
  # CSI camera pipelines
  CSI_NVIDIA: "nvarguscamerasrc sensor-id={sensor_id} ! video/x-raw(memory:NVMM),width={width},height={height},format=NV12,framerate={fps}/1 ! nvvidconv flip-method={flip_method} ! video/x-raw,format=BGRx ! videoconvert ! video/x-raw,format=BGR ! appsink drop=true sync=false"
  
  CSI_RPI: "libcamerasrc ! video/x-raw,width={width},height={height},framerate={fps}/1 ! videoconvert ! video/x-raw,format=BGR ! appsink drop=true sync=false"
  
  # Network stream pipelines
  RTSP: "rtspsrc location={url} latency={latency} ! decodebin ! videoconvert ! video/x-raw,format=BGR ! videoscale ! video/x-raw,width={width},height={height} ! appsink drop=true sync=false"
  
  UDP: "udpsrc uri={url} ! application/x-rtp ! rtph264depay ! avdec_h264 ! videoconvert ! video/x-raw,format=BGR ! videoscale ! video/x-raw,width={width},height={height} ! appsink drop=true sync=false"
  
  HTTP: "souphttpsrc location={url} ! decodebin ! videoconvert ! video/x-raw,format=BGR ! videoscale ! video/x-raw,width={width},height={height} ! appsink drop=true sync=false"

# ==============================================================================
# FRAME WINDOW & DISPLAY
# ==============================================================================
FrameEstimation:
  # üñºÔ∏è Video display window settings
  FRAME_TITLE: Video                        # Window title
  DEFAULT_FPS: 30                           # DEPRECATED: Use VideoSource/DEFAULT_FPS
  SHOW_VIDEO_WINDOW: false                  # true for debugging with display

# ==============================================================================
# ESTIMATOR (Kalman Filter for Tracking)
# ==============================================================================
Estimator:
  # üìä State estimation for smooth tracking
  USE_ESTIMATOR: true
  ESTIMATOR_TYPE: Kalman                    # Options: Kalman, None
  ESTIMATOR_ENABLED: true                   # DEPRECATED: Use USE_ESTIMATOR
  ESTIMATOR_HISTORY_LENGTH: 5               # State history buffer
  
  # === Kalman Filter Parameters ===
  ESTIMATOR_PROCESS_NOISE_VARIANCE: 10.0    # Motion uncertainty
  ESTIMATOR_MEASUREMENT_NOISE_VARIANCE: 1.0 # Sensor noise
  # Initial covariance: [x, y, dx, dy, ddx, ddy]
  ESTIMATOR_INITIAL_STATE_COVARIANCE: [5, 5, 50, 50, 100, 100]
  
  # === Usage ===
  USE_ESTIMATOR_FOR_FOLLOWING: true         # Use predictions for control
  
  # === Visualization ===
  ESTIMATED_POSITION_COLOR: [255, 0, 0]     # Blue: tracking active
  ESTIMATION_ONLY_COLOR: [0, 165, 255]      # Orange: prediction only

# ==============================================================================
# FRAME PREPROCESSING
# ==============================================================================
FramePreprocessor:
  # üé® Image enhancement for better tracking
  ENABLE_PREPROCESSING: true
  
  # === Blur (noise reduction) ===
  PREPROCESSING_USE_BLUR: true
  PREPROCESSING_BLUR_KERNEL_SIZE: 5         # Must be odd (3, 5, 7...)
  PREPROCESSING_USE_MEDIAN_BLUR: false
  PREPROCESSING_MEDIAN_BLUR_KERNEL_SIZE: 5
  
  # === Contrast Enhancement ===
  PREPROCESSING_USE_CLAHE: true             # Adaptive histogram equalization
  PREPROCESSING_CLAHE_CLIP_LIMIT: 2.0       # Contrast limit
  PREPROCESSING_CLAHE_TILE_GRID_SIZE: 8     # Grid size (1-10)
  
  # === Color Space ===
  PREPROCESSING_COLOR_SPACE: BGR            # Options: BGR, GRAY, HSV, LAB

# ==============================================================================
# SEGMENTATION
# ==============================================================================
Segmentation:
  # üé≠ Object segmentation for precise tracking
  SEGMENTATION_ALGORITHMS: ['GrabCut', 'Watershed', 'yolov8s-seg', 'yolov8n-oiv7', 'yolov8s-obb','yolov11n']
  DEFAULT_SEGMENTATION_ALGORITHM: yolov11n.pt
  USE_SEGMENTATION_FOR_TRACKING: true
  
  # === Morphological Operations ===
  MORPHOLOGICAL_KERNEL_SIZE: 5
  DILATION_ITERATIONS: 2
  EROSION_ITERATIONS: 1
  
  # === GrabCut Parameters ===
  SEGMENTATION_GRABCUT_ITER: 5
  SEGMENTATION_MIN_AREA: 500                # Min segment area in pixels

# ==============================================================================
# YAW CONTROL
# ==============================================================================
YawControl:
  # üîÑ Drone yaw (heading) control
  ENABLE_YAW_CONTROL: false
  YAW_CONTROL_THRESHOLD: 0.3                # Activation threshold
  YAW_LATERAL_BLEND_FACTOR: 0.5             # Blend yaw with lateral motion
  YAW_DEAD_ZONE: 0.2                        # Ignore small errors

# ==============================================================================
# VERTICAL ERROR RECALCULATION
# ==============================================================================
VerticalErrorRecalculation:
  # üìê Altitude control parameters
  VERTICAL_RECALC_DELAY: 0.1                # Seconds
  YAW_PITCH_SYNC_FACTOR: 0.5                # Coupling factor

# ==============================================================================
# GIMBAL CONTROL
# ==============================================================================
Gimbal:
  # üì∑ Camera gimbal settings
  ENABLE_GIMBAL_PRIORITY: true              # Gimbal overrides body motion

# ==============================================================================
# ADAPTIVE CONTROL
# ==============================================================================
AdaptiveControl:
  # üîß Adaptive control features
  ADAPTIVE_YAW_CONTROL: false               # Auto-tune yaw gains

# ==============================================================================
# CHASE FOLLOWER LIMITS
# ==============================================================================
ChaseFollower:
  # üöÅ Safety limits for chase mode
  MAX_ROLL_RATE: 20.0                      # deg/s
  MAX_PITCH_RATE: 10.0                     # deg/s
  MAX_YAW_RATE: 10.0                       # deg/s
  MAX_THRUST: 1.0                          # 0-1
  MIN_THRUST: 0.3                          # 0-1
  MIN_GROUND_SPEED: 0                      # m/s
  MAX_GROUND_SPEED: 100                    # m/s
  TARGET_SPEED: 60                         # m/s
  MAX_BANK_ANGLE: 20                       # degrees
  YAW_ERROR_CHECK_ENABLED: true
  YAW_ERROR_THRESHOLD: 20                  # degrees
  ALTITUDE_FAILSAFE_ENABLED: false

# ==============================================================================
# PID CONTROLLER
# ==============================================================================
PID:
  # ‚öôÔ∏è PID gains for each control axis
  # All angular rates in deg/s (MAVSDK standard)
  # One PID gain set per physical axis - no duplicates
  PID_GAINS:
    x: {p: 4.5, i: 0.1, d: 1.5}            # Lateral position
    y: {p: 4.5, i: 0.1, d: 1.5}            # Longitudinal position
    z: {p: 2, i: 0.03, d: 0.05}            # Vertical position
    rollspeed_deg_s: {p: 1, i: 0.05, d: 0.2}     # Roll rate (deg/s)
    pitchspeed_deg_s: {p: 20, i: 0.1, d: 0.4}    # Pitch rate (deg/s)
    yawspeed_deg_s: {p: 0.9, i: 0.05, d: 0.1}    # Yaw rate (deg/s)
    thrust: {p: 0.1, i: 3, d: 1}
    vel_body_right: {p: 1.0, i: 0.02, d: 0.1}
    vel_body_down: {p: 0.75, i: 0.05, d: 0.1}
    # Fixed-wing specific PID gains (L1/TECS follower)
    fw_roll_rate: {p: 0.8, i: 0.1, d: 0.05}       # Roll rate inner loop
    fw_pitch_rate: {p: 0.6, i: 0.15, d: 0.03}     # Pitch rate (TECS output)
    fw_yaw_rate: {p: 0.5, i: 0.05, d: 0.02}       # Yaw rate (L1 output)
    fw_throttle: {p: 0.4, i: 0.2, d: 0.1}         # Throttle (TECS energy)
    fw_bank_angle: {p: 2.0, i: 0.3, d: 0.2}       # Bank angle outer loop
    # Multicopter specific PID gains (dual-mode follower)
    mc_yawspeed_deg_s: {p: 15.0, i: 0.5, d: 2.0}  # Yaw rate for YAW_TO_TARGET mode
    mc_vel_body_right: {p: 8.0, i: 0.2, d: 1.0}   # Lateral velocity for CRAB_STRAFE mode
    mc_vel_body_down: {p: 5.0, i: 0.3, d: 0.8}    # Vertical velocity control
    # Multicopter attitude rate specific PID gains (aggressive tracking)
    mcar_pitchspeed_deg_s: {p: 18.0, i: 0.15, d: 0.4}  # Pitch rate (aggressive response)
    mcar_yawspeed_deg_s: {p: 12.0, i: 0.1, d: 0.3}     # Yaw rate (turn to target)
    mcar_rollspeed_deg_s: {p: 1.5, i: 0.08, d: 0.25}   # Roll rate (coordinated turns)
    mcar_thrust: {p: 0.15, i: 0.5, d: 0.2}             # Thrust (altitude hold)
    mcar_altitude: {p: 2.0, i: 0.3, d: 0.5}            # Altitude (explicit control)
  # === Advanced PID Features ===
  PROPORTIONAL_ON_MEASUREMENT: false        # Avoid derivative kick
  ENABLE_ANTI_WINDUP: true                  # Prevent integral windup
  ANTI_WINDUP_BACK_CALC_COEFF: 0.1         # Back-calculation coefficient

# ==============================================================================
# SAFETY LIMITS - GLOBAL DEFAULTS
# ==============================================================================
# System-wide safety limits that apply to ALL followers by default.
# Individual followers can override these in their own sections if needed.
# Priority: Follower-specific override > Global SafetyLimits > Hardcoded fallback
#
# Naming Convention (unified across all followers):
#   - MIN_ALTITUDE: Minimum safe operating altitude (meters)
#   - MAX_ALTITUDE: Maximum safe operating altitude (meters)
#   - MAX_VELOCITY_FORWARD: Maximum forward velocity (m/s)
#   - MAX_VELOCITY_LATERAL: Maximum lateral/sideways velocity (m/s)
#   - MAX_VELOCITY_VERTICAL: Maximum vertical velocity (m/s)
#   - MAX_YAW_RATE: Maximum yaw rotation rate (deg/s)
# ==============================================================================
SafetyLimits:
  # === Altitude Boundaries ===
  MIN_ALTITUDE: 3.0                    # meters - Absolute minimum safe altitude
  MAX_ALTITUDE: 120.0                  # meters - Maximum altitude (regulatory compliance)

  # === Velocity Limits (Conservative defaults for beginners) ===
  MAX_VELOCITY_FORWARD: 2.0            # m/s - Maximum forward velocity (conservative)
  MAX_VELOCITY_LATERAL: 2.0            # m/s - Maximum lateral velocity (conservative)
  MAX_VELOCITY_VERTICAL: 1.0           # m/s - Maximum vertical velocity (conservative)

  # === Rotation Limits ===
  MAX_YAW_RATE: 30.0                   # deg/s - Maximum yaw rotation rate (conservative)

  # === Safety Behavior ===
  ALTITUDE_WARNING_BUFFER: 2.0         # meters - Warning zone before hard limits
  EMERGENCY_STOP_ENABLED: false        # ‚ö†Ô∏è Disabled by default for ground testing (enable for flights)
  RTL_ON_VIOLATION: false              # ‚ö†Ô∏è Disabled by default for ground testing (enable for flights)
  MAX_SAFETY_VIOLATIONS: 5             # Max violations before emergency action

# ==============================================================================
# GAIN SCHEDULING
# ==============================================================================
GainScheduling:
  # üìà Altitude-based gain adjustment
  ENABLE_GAIN_SCHEDULING: false
  GAIN_SCHEDULING_PARAMETER: current_altitude
  
  # Altitude ranges and corresponding gains
  ALTITUDE_GAIN_SCHEDULE:
    '(0, 20)':      # 0-20m altitude
      x: {p: 5.5, i: 0.2, d: 0.4}
      y: {p: 5.5, i: 0.2, d: 0.4}
      z: {p: 1, i: 0.01, d: 0.1}
    '(20, 50)':     # 20-50m altitude
      x: {p: 6, i: 0.25, d: 0.5}
      y: {p: 6, i: 0.25, d: 0.5}
      z: {p: 1, i: 0.015, d: 0.15}
    '(50, 100)':    # 50-100m altitude
      x: {p: 6.5, i: 0.3, d: 0.6}
      y: {p: 6.5, i: 0.3, d: 0.6}
      z: {p: 1, i: 0.02, d: 0.2}
    '(100, 150)':   # 100-150m altitude
      x: {p: 6, i: 0.3, d: 1.0}
      y: {p: 6, i: 0.3, d: 1.0}
      z: {p: 1, i: 0.01, d: 0.01}
    '(150, 200)':   # 150-200m altitude
      x: {p: 5.5, i: 0.25, d: 0.8}
      y: {p: 5.5, i: 0.25, d: 0.8}
      z: {p: 1, i: 0.01, d: 0.05}

# ==============================================================================
# SETPOINT CONTROL
# ==============================================================================
Setpoint:
  # üìç Position/velocity setpoint configuration
  CAMERA_YAW_OFFSET: 0                     # Camera mounting offset (degrees)
  SETPOINT_PUBLISH_RATE_S: 0.1             # Setpoint update period (seconds)
  ENABLE_SETPOINT_DEBUGGING: false         # Debug output

# ==============================================================================
# TELEMETRY
# ==============================================================================
Telemetry:
  # üìä Telemetry data distribution
  ENABLE_TELEMETRY: true
  TELEMETRY_SEND_RATE: 2                   # Hz
  TELEMETRY_FLASK_ENDPOINT: /telemetry     # REST endpoint
  
  # === UDP Telemetry ===
  ENABLE_UDP_STREAM: false
  UDP_HOST: 127.0.0.1
  UDP_PORT: 5550
  
  # === WebSocket Telemetry ===
  WEBSOCK_HOST: 127.0.0.1
  WEBSOCK_PORT: 5551
  
  # === Data Selection ===
  ENABLE_FOLLOWER_TELEMETRY: true          # Include follower status

# ==============================================================================
# GSTREAMER OUTPUT STREAM (Secondary Output)
# ==============================================================================
GStreamer:
  # üìπ Optional GStreamer pipeline for external streaming
  ENABLE_GSTREAMER_STREAM: false
  GSTREAMER_HOST: 127.0.0.1
  GSTREAMER_PORT: 2000
  GSTREAMER_BITRATE: 2000                  # kbps
  GSTREAMER_WIDTH: 1280
  GSTREAMER_HEIGHT: 720
  GSTREAMER_FRAMERATE: 15
  GSTREAMER_BUFFER_SIZE: 50000000          # bytes
  GSTREAMER_SPEED_PRESET: ultrafast        # x264 preset
  GSTREAMER_KEY_INT_MAX: 30                # Keyframe interval
  GSTREAMER_TUNE: zerolatency               # x264 tuning
  
  # === Video Enhancement ===
  GSTREAMER_CONTRAST: 5.0
  GSTREAMER_BRIGHTNESS: 10
  GSTREAMER_SATURATION: 5

# ==============================================================================
# OSD (ON-SCREEN DISPLAY)
# ==============================================================================
# üì∫ Professional On-Screen Display System
#
# Configuration Philosophy:
# - This section contains ONLY general OSD settings
# - All element configurations (what, where, how) are in preset files
# - Presets are located in: configs/osd_presets/
#
# Available Presets:
# - minimal.yaml: Essential info only (altitude, battery, status)
# - professional.yaml: Balanced aviation-standard layout (RECOMMENDED)
# - full_telemetry.yaml: All available data (testing/debugging)
#
# Adding Custom Presets:
# 1. Create new YAML file in configs/osd_presets/
# 2. Copy structure from existing preset
# 3. Set OSD_PRESET below to your filename (without .yaml)
# 4. All MAVLink data points are automatically available
#
# Adding New MAVLink Fields to OSD:
# 1. Ensure field exists in MAVLink.MAVLINK_DATA_POINTS section above
# 2. Open your chosen preset file (e.g., professional.yaml)
# 3. Add field to mavlink_data.fields section with positioning/styling
# 4. Available fields: heading, altitude_agl, altitude_msl, airspeed,
#    groundspeed, voltage, satellites_visible, hdop, vdop, latitude,
#    longitude, roll, pitch, throttle, climb, flight_mode, etc.
#
# ==============================================================================
OSD:
  # === General Settings ===
  OSD_ENABLED: true                      # Master enable/disable for OSD

  # === Preset Selection ===
  OSD_PRESET: "professional"             # Active preset filename (without .yaml)
                                         # Options: minimal | professional | full_telemetry
                                         # Or your custom preset name

  # === Performance Mode ===
  # Choose rendering mode based on your hardware:
  # "fast"     - OpenCV rendering (2-3ms/frame) - For Raspberry Pi, Jetson Nano
  # "balanced" - PIL with native stroke (5-8ms/frame) - RECOMMENDED for most systems
  # "quality"  - PIL with manual outline (50-80ms/frame) - For high-end desktops/recording
  OSD_PERFORMANCE_MODE: "balanced"

  # ‚ÑπÔ∏è NOTE: All element configurations are loaded from the preset file
  # ‚ÑπÔ∏è See configs/osd_presets/{OSD_PRESET}.yaml for layout and styling

# ==============================================================================
# DEBUGGING & LOGGING
# ==============================================================================
Debugging:
  # üêõ Debug and logging configuration
  ENABLE_DEBUGGING: true
  LOG_FILE_PATH: logs/tracking_log.txt
  LOG_LEVEL: INFO                          # DEBUG, INFO, WARNING, ERROR
  SAVE_DEBUG_FRAMES: false                 # Save frames for analysis
  DEBUG_FRAME_PATH: debug_frames/          # Debug frame storage

# ==============================================================================
# DEPRECATED PARAMETERS
# ==============================================================================
# ‚ö†Ô∏è These parameters are kept for backward compatibility but should not be used
# in new deployments. They will be removed in future versions.
#
# CSI_WIDTH/HEIGHT/FRAMERATE ‚Üí Use CAPTURE_WIDTH/HEIGHT/FPS in VideoSource
# ESTIMATOR_ENABLED ‚Üí Use USE_ESTIMATOR in Estimator section
# DEFAULT_FPS in FrameEstimation ‚Üí Use DEFAULT_FPS in VideoSource
# ==============================================================================